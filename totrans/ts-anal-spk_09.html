<html><head></head><body>
<div epub:type="chapter" id="_idContainer157">
<h1 class="chapter-number" id="_idParaDest-168"><a id="_idTextAnchor169"/><span class="koboSpan" id="kobo.1.1">9</span></h1>
<h1 id="_idParaDest-169"><a id="_idTextAnchor170"/><span class="koboSpan" id="kobo.2.1">Going to Production</span></h1>
<p><span class="koboSpan" id="kobo.3.1">With our time series analysis model built and tested, and the ability to scale seen in the previous chapter, we will now explore the practical considerations and steps involved in deploying time series models into production with the Spark framework. </span><span class="koboSpan" id="kobo.3.2">This information is crucial to guide you through the transition from development to real-world implementation, ensuring the reliability and effectiveness of time series models in operational environments. </span><span class="koboSpan" id="kobo.3.3">With many machine learning projects stuck in development and proof of concept stages, grasping the nuances of deploying to production enhances your ability to integrate time series analyses seamlessly into </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">decision-making processes.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">While in </span><a href="B18568_04.xhtml#_idTextAnchor087"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.6.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.7.1"> we covered the broader end-to-end view of a time series analysis project, in this chapter, we’re going to focus on going to production with the following </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">main topics:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.9.1">Workflows</span></span></li>
<li><span class="koboSpan" id="kobo.10.1">Monitoring </span><span class="No-Break"><span class="koboSpan" id="kobo.11.1">and reporting</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.12.1">Additional considerations</span></span></li>
</ul>
<h1 id="_idParaDest-170"><a id="_idTextAnchor171"/><span class="koboSpan" id="kobo.13.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.14.1">In this chapter, we will explore with code examples the deployment of a scalable end-to-end workflow for time series analysis in our own container-based environment. </span><span class="koboSpan" id="kobo.14.2">A tremendous amount of work goes into building a production-ready environment, which goes way beyond what we can reasonably cover in this chapter. </span><span class="koboSpan" id="kobo.14.3">We will focus instead on providing an example as a starting point. </span><span class="koboSpan" id="kobo.14.4">We will see how what we have learned so far about time series analysis comes together to create an </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">end-to-end workflow.</span></span></p>
<p><span class="koboSpan" id="kobo.16.1">The code for this chapter can be found at this </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">URL: </span></span><a href="https://github.com/PacktPublishing/Time-Series-Analysis-with-Spark/tree/main/ch9"><span class="No-Break"><span class="koboSpan" id="kobo.18.1">https://github.com/PacktPublishing/Time-Series-Analysis-with-Spark/tree/main/ch9</span></span></a></p>
<p><span class="koboSpan" id="kobo.19.1">Let’s start by setting up our environment for </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">the example.</span></span></p>
<h1 id="_idParaDest-171"><a id="_idTextAnchor172"/><span class="koboSpan" id="kobo.21.1">Environment setup</span></h1>
<p><span class="koboSpan" id="kobo.22.1">We will be using Docker containers, like in </span><a href="B18568_03.xhtml#_idTextAnchor063"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.23.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.24.1"> and </span><a href="B18568_04.xhtml#_idTextAnchor087"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.25.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.26.1">, for the platform infrastructure. </span><span class="koboSpan" id="kobo.26.2">Follow the instructions in the </span><em class="italic"><span class="koboSpan" id="kobo.27.1">Using a container for deployment</span></em><span class="koboSpan" id="kobo.28.1"> section of </span><a href="B18568_03.xhtml#_idTextAnchor063"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.29.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.30.1"> and the </span><em class="italic"><span class="koboSpan" id="kobo.31.1">Environment setup</span></em><span class="koboSpan" id="kobo.32.1"> section of </span><a href="B18568_04.xhtml#_idTextAnchor087"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.33.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.34.1"> on setting up the </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">container environment.</span></span></p>
<p><span class="koboSpan" id="kobo.36.1">Once the </span><a id="_idIndexMarker757"/><span class="koboSpan" id="kobo.37.1">environment is set up, download the deployment script from the Git repository for this chapter, which is at the </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">following URL:</span></span></p>
<p><a href="https://github.com/PacktPublishing/Time-Series-Analysis-with-Spark/tree/main/ch9"><span class="No-Break"><span class="koboSpan" id="kobo.39.1">https://github.com/PacktPublishing/Time-Series-Analysis-with-Spark/tree/main/ch9</span></span></a></p>
<p><span class="koboSpan" id="kobo.40.1">You can then start the container environment as per the </span><em class="italic"><span class="koboSpan" id="kobo.41.1">Environment startup</span></em><span class="koboSpan" id="kobo.42.1"> section of </span><a href="B18568_04.xhtml#_idTextAnchor087"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.43.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.44.1">. </span><span class="koboSpan" id="kobo.44.2">Do a quick visual validation of the components as per the </span><em class="italic"><span class="koboSpan" id="kobo.45.1">Accessing the UIs</span></em><span class="koboSpan" id="kobo.46.1"> section of the </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">same chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.48.1">Before we get into the nitty-gritty of the code, let’s step back with an overview of the workflow to see the big picture of what we will be building in </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">this section.</span></span></p>
<h1 id="_idParaDest-172"><a id="_idTextAnchor173"/><span class="koboSpan" id="kobo.50.1">Workflows</span></h1>
<p><span class="koboSpan" id="kobo.51.1">The code </span><a id="_idIndexMarker758"/><span class="koboSpan" id="kobo.52.1">example in this chapter includes two workflows. </span><span class="koboSpan" id="kobo.52.2">These </span><a id="_idIndexMarker759"/><span class="koboSpan" id="kobo.53.1">are implemented as </span><strong class="bold"><span class="koboSpan" id="kobo.54.1">Directed Acyclic Graphs</span></strong><span class="koboSpan" id="kobo.55.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.56.1">DAGs</span></strong><span class="koboSpan" id="kobo.57.1">) in Airflow, like in </span><a href="B18568_04.xhtml#_idTextAnchor087"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.58.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.59.1">. </span><span class="koboSpan" id="kobo.59.2">The best way to visualize the workflows is from the DAG views in Airflow, as per </span><em class="italic"><span class="koboSpan" id="kobo.60.1">Figures 9.1</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.61.1">and </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.62.1">9.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.64.1">The two workflows are </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.66.1">ts-spark_ch9_data-ml-ops</span></strong><span class="koboSpan" id="kobo.67.1">: This </span><a id="_idIndexMarker760"/><span class="koboSpan" id="kobo.68.1">is an example of the end-to-end process, shown </span><a id="_idIndexMarker761"/><span class="koboSpan" id="kobo.69.1">in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.70.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.71.1">.1</span></em><span class="koboSpan" id="kobo.72.1">, which includes the </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">following tasks:</span></span><ul><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.74.1">get_config</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.75.1">ingest_train_data</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.76.1">transform_train_data</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.77.1">train_and_log_model</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.78.1">forecast</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.79.1">ingest_eval_data</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.80.1">transform_eval_data</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.81.1">eval_forecast</span></strong></span></li></ul></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer138">
<span class="koboSpan" id="kobo.82.1"><img alt="" src="image/B18568_09_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.83.1">Figure 9.1: Airflow DAG for the end-to-end workflow</span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.84.1">ts-spark_ch9_data-ml-ops_runall</span></strong><span class="koboSpan" id="kobo.85.1">: This second workflow, shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.86.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.87.1">.2</span></em><span class="koboSpan" id="kobo.88.1">, calls </span><a id="_idIndexMarker762"/><span class="koboSpan" id="kobo.89.1">the preceding </span><a id="_idIndexMarker763"/><span class="koboSpan" id="kobo.90.1">one multiple times with different ranges of dates. </span><span class="koboSpan" id="kobo.90.2">It simulates what happens in the real world whereby the preceding end-to-end workflow is launched at a regular interval, say daily or weekly, with </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">new data.</span></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer139">
<span class="koboSpan" id="kobo.92.1"><img alt="" src="image/B18568_09_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.93.1">Figure 9.2: Airflow DAG with multiple calls to the end-to-end workflow</span></p>
<p><span class="koboSpan" id="kobo.94.1">The code for these Airflow DAGs is in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">dags</span></strong><span class="koboSpan" id="kobo.96.1"> folder. </span><span class="koboSpan" id="kobo.96.2">They are in Python (</span><strong class="source-inline"><span class="koboSpan" id="kobo.97.1">.py</span></strong><span class="koboSpan" id="kobo.98.1"> files) and can be visualized via a text, or preferably a </span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">code, editor.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.100.1">Modularity</span></p>
<p class="callout"><span class="koboSpan" id="kobo.101.1">It is worth noting that for the example here, we could have joined up all the code of these individual tasks into one big task. </span><span class="koboSpan" id="kobo.101.2">Instead, we have broken the workflow into multiple tasks to illustrate the best practice of modularization. </span><span class="koboSpan" id="kobo.101.3">In a real-world situation, this facilitates independent code change, scaling, and task reruns. </span><span class="koboSpan" id="kobo.101.4">Different teams may have ownership of </span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">the tasks.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.103.1">Workflow separation</span></p>
<p class="callout"><span class="koboSpan" id="kobo.104.1">The workflows we are demonstrating in this example can be further separated in your own implementation. </span><span class="koboSpan" id="kobo.104.2">For instance, it is common to have the model-training-related tasks, the </span><a id="_idIndexMarker764"/><span class="koboSpan" id="kobo.105.1">forecasting, and the model evaluation in their own individual workflows launched at different </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">time intervals.</span></span></p>
<p><span class="koboSpan" id="kobo.107.1">We will explain each of these DAGs and related tasks in detail in the upcoming sections, starting </span><span class="No-Break"><span class="koboSpan" id="kobo.108.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.109.1">ts-spark_ch9_data-ml-ops_runall</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.110.1">.</span></span></p>
<h2 id="_idParaDest-173"><a id="_idTextAnchor174"/><span class="koboSpan" id="kobo.111.1">Simulation and runs</span></h2>
<p><span class="koboSpan" id="kobo.112.1">As we saw in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.113.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.114.1">.2</span></em><span class="koboSpan" id="kobo.115.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">ts-spark_ch9_data-ml-ops_runall</span></strong><span class="koboSpan" id="kobo.117.1"> has five tasks, which we will explain </span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">further here.</span></span></p>
<p><span class="koboSpan" id="kobo.119.1">The purpose </span><a id="_idIndexMarker765"/><span class="koboSpan" id="kobo.120.1">of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.121.1">_runall</span></strong><span class="koboSpan" id="kobo.122.1"> workflow is to simulate the real-world execution of the cycle of training, forecasting, and evaluation at regular intervals. </span><span class="koboSpan" id="kobo.122.2">In our example, each task of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.123.1">_runall</span></strong><span class="koboSpan" id="kobo.124.1"> workflow corresponds to one cycle of training, forecasting, and evaluation. </span><span class="koboSpan" id="kobo.124.2">We will call each task a run and have five runs in all, corresponding to the five tasks of </span><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">_runall</span></strong><span class="koboSpan" id="kobo.126.1">. </span><span class="koboSpan" id="kobo.126.2">These tasks will be scheduled at regular intervals, daily, weekly, monthly, or so. </span><span class="koboSpan" id="kobo.126.3">In the example here, we are just running them sequentially, one after </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">the other.</span></span></p>
<p><span class="koboSpan" id="kobo.128.1">Each task </span><a id="_idIndexMarker766"/><span class="koboSpan" id="kobo.129.1">calls the </span><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">ts-spark_ch9_data-ml-ops</span></strong><span class="koboSpan" id="kobo.131.1"> workflow with a different set of parameters. </span><span class="koboSpan" id="kobo.131.2">They are </span><span class="No-Break"><span class="koboSpan" id="kobo.132.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">runid</span></strong><span class="koboSpan" id="kobo.134.1">: An integer to identify </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">the run</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.136.1">START_DATE</span></strong><span class="koboSpan" id="kobo.137.1">: The start date in the time series dataset to use </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">for training</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.139.1">TRAIN_END_DATE</span></strong><span class="koboSpan" id="kobo.140.1">: The end date in the time series dataset </span><span class="No-Break"><span class="koboSpan" id="kobo.141.1">for training</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.142.1">EVAL_END_DATE</span></strong><span class="koboSpan" id="kobo.143.1">: The end date in the time series dataset </span><span class="No-Break"><span class="koboSpan" id="kobo.144.1">for evaluation</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.145.1">The way the different runs are configured is with a sliding window of 5 years of training data and 1 year of evaluation data in our example. </span><span class="koboSpan" id="kobo.145.2">In a real-world scenario, the evaluation date range is likely to be shorter, corresponding to a shorter </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">forecasting horizon.</span></span></p>
<p><span class="koboSpan" id="kobo.147.1">The run configurations are </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">as follows:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.149.1">conf_run1</span></strong><span class="koboSpan" id="kobo.150.1"> = {
    'runid':          1,
    'START_DATE':     '1981-01-01',
    'TRAIN_END_DATE': '1985-12-31',
    'EVAL_END_DATE':  '1986-12-31',
}
conf_run2 = {
    'runid':          2,
    'START_DATE':     '1982-01-01',
    'TRAIN_END_DATE': '1986-12-31',
    'EVAL_END_DATE':  '1987-12-31',
}
…</span></pre> <p><span class="koboSpan" id="kobo.151.1">The tasks </span><a id="_idIndexMarker767"/><span class="koboSpan" id="kobo.152.1">are defined as follows to trigger the </span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">ts-spark_ch9_data-ml-ops</span></strong><span class="koboSpan" id="kobo.154.1"> workflow passing the run configuration as </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">a parameter:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.156.1">
# Define tasks
t1 = TriggerDagRunOperator(
    task_id="ts-spark_ch9_data-ml-ops_1",
    trigger_dag_id="</span><strong class="bold"><span class="koboSpan" id="kobo.157.1">ts-spark_ch9_data-ml-ops</span></strong><span class="koboSpan" id="kobo.158.1">",
    conf=</span><strong class="bold"><span class="koboSpan" id="kobo.159.1">conf_run1</span></strong><span class="koboSpan" id="kobo.160.1">,
    wait_for_completion=True,
    dag=dag,
)
t2 = TriggerDagRunOperator(
    task_id="ts-spark_ch9_data-ml-ops_2",
    trigger_dag_id="ts-spark_ch9_data-ml-ops",
    conf=conf_run2,
    wait_for_completion=True,
    dag=dag,
)
…</span></pre> <p><span class="koboSpan" id="kobo.161.1">The tasks are then launched sequentially </span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.163.1">
t1 &gt;&gt; t2 &gt;&gt; t3 &gt;&gt; t4 &gt;&gt; t5</span></pre> <p><span class="koboSpan" id="kobo.164.1">You can </span><a id="_idIndexMarker768"/><span class="koboSpan" id="kobo.165.1">kick off this </span><strong class="source-inline"><span class="koboSpan" id="kobo.166.1">ts-spark_ch9_data-ml-ops_runall</span></strong><span class="koboSpan" id="kobo.167.1"> Airflow DAG from the Airflow DAG view as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.168.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.169.1">.3</span></em><span class="koboSpan" id="kobo.170.1">, by clicking on the run (</span><strong class="bold"><span class="koboSpan" id="kobo.171.1">&gt;</span></strong><span class="koboSpan" id="kobo.172.1">) button highlighted </span><span class="No-Break"><span class="koboSpan" id="kobo.173.1">in green.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer140">
<span class="koboSpan" id="kobo.174.1"><img alt="" src="image/B18568_09_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.175.1">Figure 9.3: Run the Airflow DAG</span></p>
<p><span class="koboSpan" id="kobo.176.1">The outcome of this DAG can be seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.177.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.178.1">.2</span></em><span class="koboSpan" id="kobo.179.1">, showing the status of the </span><span class="No-Break"><span class="koboSpan" id="kobo.180.1">individual tasks.</span></span></p>
<p><span class="koboSpan" id="kobo.181.1">We will now discuss the details of these tasks, which, as we have seen, call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">ts-spark_ch9_data-ml-ops</span></strong><span class="koboSpan" id="kobo.183.1"> workflow with different parameters. </span><span class="koboSpan" id="kobo.183.2">Let’s start with the first step, </span><strong class="source-inline"><span class="koboSpan" id="kobo.184.1">get_config</span></strong><span class="koboSpan" id="kobo.185.1">, tasked with handling </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">these parameters.</span></span></p>
<h2 id="_idParaDest-174"><a id="_idTextAnchor175"/><span class="koboSpan" id="kobo.187.1">Configuration</span></h2>
<p><span class="koboSpan" id="kobo.188.1">The </span><a id="_idIndexMarker769"/><span class="koboSpan" id="kobo.189.1">first task in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">ts-spark_ch9_data-ml-ops</span></strong><span class="koboSpan" id="kobo.191.1"> workflow is </span><strong class="source-inline"><span class="koboSpan" id="kobo.192.1">t0</span></strong><span class="koboSpan" id="kobo.193.1"> and it calls the </span><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">get_config</span></strong><span class="koboSpan" id="kobo.195.1"> function to retrieve the configuration needed to run the workflow. </span><span class="koboSpan" id="kobo.195.2">These are passed as parameters when calling the workflow. </span><span class="koboSpan" id="kobo.195.3">They are, as mentioned earlier, the run identifier and date ranges of the time series data for which we want to run the workflow. </span><span class="koboSpan" id="kobo.195.4">We will see how they are used in the </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">subsequent tasks.</span></span></p>
<p><span class="koboSpan" id="kobo.197.1">The </span><a id="_idIndexMarker770"/><span class="koboSpan" id="kobo.198.1">code that defines task </span><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">t0</span></strong><span class="koboSpan" id="kobo.200.1"> is </span><span class="No-Break"><span class="koboSpan" id="kobo.201.1">as follows:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.202.1">t0</span></strong><span class="koboSpan" id="kobo.203.1"> = PythonOperator(
    task_id='get_config',
    python_callable=</span><strong class="bold"><span class="koboSpan" id="kobo.204.1">get_config</span></strong><span class="koboSpan" id="kobo.205.1">,
    op_kwargs={'_vars': {
        '</span><strong class="bold"><span class="koboSpan" id="kobo.206.1">runid</span></strong><span class="koboSpan" id="kobo.207.1">': "{{ dag_run.conf['</span><strong class="bold"><span class="koboSpan" id="kobo.208.1">runid</span></strong><span class="koboSpan" id="kobo.209.1">'] }}",
        '</span><strong class="bold"><span class="koboSpan" id="kobo.210.1">START_DATE</span></strong><span class="koboSpan" id="kobo.211.1">': "{{ dag_run.conf['</span><strong class="bold"><span class="koboSpan" id="kobo.212.1">START_DATE</span></strong><span class="koboSpan" id="kobo.213.1">'] }}",
        '</span><strong class="bold"><span class="koboSpan" id="kobo.214.1">TRAIN_END_DATE</span></strong><span class="koboSpan" id="kobo.215.1">': "{{ dag_run.conf['</span><strong class="bold"><span class="koboSpan" id="kobo.216.1">TRAIN_END_DATE</span></strong><span class="koboSpan" id="kobo.217.1">'] }}",
        '</span><strong class="bold"><span class="koboSpan" id="kobo.218.1">EVAL_END_DATE</span></strong><span class="koboSpan" id="kobo.219.1">': "{{ dag_run.conf['</span><strong class="bold"><span class="koboSpan" id="kobo.220.1">EVAL_END_DATE</span></strong><span class="koboSpan" id="kobo.221.1">'] }}",
        },
    },
    provide_context=True,
    dag=dag,
)</span></pre> <p><span class="koboSpan" id="kobo.222.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.223.1">get_config</span></strong><span class="koboSpan" id="kobo.224.1"> function, which </span><a id="_idIndexMarker771"/><span class="koboSpan" id="kobo.225.1">is called by task </span><strong class="source-inline"><span class="koboSpan" id="kobo.226.1">t0</span></strong><span class="koboSpan" id="kobo.227.1">, is </span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.229.1">
def </span><strong class="bold"><span class="koboSpan" id="kobo.230.1">get_config</span></strong><span class="koboSpan" id="kobo.231.1">(_vars, **kwargs):
    print(f"dag_config: {_vars}")
    return </span><strong class="bold"><span class="koboSpan" id="kobo.232.1">_vars</span></strong></pre> <p><span class="koboSpan" id="kobo.233.1">All it does is pass through the configuration parameters received at the launch of the Airflow DAG in a </span><strong class="source-inline"><span class="koboSpan" id="kobo.234.1">_vars</span></strong><span class="koboSpan" id="kobo.235.1"> variable for use by </span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">subsequent tasks.</span></span></p>
<p><span class="koboSpan" id="kobo.237.1">We can see the status of the task in the DAG view in Airflow as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.238.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.239.1">.1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">.</span></span></p>
<h2 id="_idParaDest-175"><a id="_idTextAnchor176"/><span class="koboSpan" id="kobo.241.1">Data ingestion and storage</span></h2>
<p><span class="koboSpan" id="kobo.242.1">At this step, after completion of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">t0</span></strong><span class="koboSpan" id="kobo.244.1"> task, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">t1</span></strong><span class="koboSpan" id="kobo.246.1"> task is launched by Airflow. </span><span class="koboSpan" id="kobo.246.2">It calls the </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">ingest_train_data</span></strong><span class="koboSpan" id="kobo.248.1"> function to ingest the training data from the input CSV file as specified </span><a id="_idIndexMarker772"/><span class="koboSpan" id="kobo.249.1">by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.250.1">DATASOURCE</span></strong><span class="koboSpan" id="kobo.251.1"> variable. </span><span class="koboSpan" id="kobo.251.2">In this example, as it is a relatively small file, we ingest the full file every time. </span><span class="koboSpan" id="kobo.251.3">You will likely ingest only new data points incrementally at </span><span class="No-Break"><span class="koboSpan" id="kobo.252.1">this stage.</span></span></p>
<p><span class="koboSpan" id="kobo.253.1">The code for this step is </span><span class="No-Break"><span class="koboSpan" id="kobo.254.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.255.1">
def </span><strong class="bold"><span class="koboSpan" id="kobo.256.1">ingest_train_data</span></strong><span class="koboSpan" id="kobo.257.1">(_vars, **kwargs):
    sdf = </span><strong class="bold"><span class="koboSpan" id="kobo.258.1">spark.read.csv</span></strong><span class="koboSpan" id="kobo.259.1">(
        </span><strong class="bold"><span class="koboSpan" id="kobo.260.1">DATASOURCE</span></strong><span class="koboSpan" id="kobo.261.1">, header=True, inferSchema=True
    )
    sdf = sdf.</span><strong class="bold"><span class="koboSpan" id="kobo.262.1">filter</span></strong><span class="koboSpan" id="kobo.263.1">(
        (F.col('date') &gt;= F.lit(_vars['</span><strong class="bold"><span class="koboSpan" id="kobo.264.1">START_DATE</span></strong><span class="koboSpan" id="kobo.265.1">'])) &amp;
        (F.col('date') &lt;= F.lit(_vars['</span><strong class="bold"><span class="koboSpan" id="kobo.266.1">TRAIN_END_DATE</span></strong><span class="koboSpan" id="kobo.267.1">']))
    )
    data_ingest_count = sdf.count()
    sdf.write.format("delta").mode("overwrite").save(
        f"/data/delta/ts-spark_ch9_</span><strong class="bold"><span class="koboSpan" id="kobo.268.1">bronze</span></strong><span class="koboSpan" id="kobo.269.1">_train_{_vars['</span><strong class="bold"><span class="koboSpan" id="kobo.270.1">runid</span></strong><span class="koboSpan" id="kobo.271.1">']}"
    )
    _vars['train_ingest_count'] = data_ingest_count
    return _vars</span></pre> <p><span class="koboSpan" id="kobo.272.1">The data is ingested using Spark, with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">spark.read.csv</span></strong><span class="koboSpan" id="kobo.274.1"> function, into a Spark DataFrame. </span><span class="koboSpan" id="kobo.274.2">We then filter the data for the range of dates that fall within the training dataset as per the </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">START_DATE</span></strong><span class="koboSpan" id="kobo.276.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">TRAIN_END_DATE</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.278.1"> parameters.</span></span></p>
<p><span class="koboSpan" id="kobo.279.1">We want to be able to later report on how much data we ingest every time. </span><span class="koboSpan" id="kobo.279.2">To enable this, we count the number of rows in </span><span class="No-Break"><span class="koboSpan" id="kobo.280.1">the DataFrame.</span></span></p>
<p><span class="koboSpan" id="kobo.281.1">Finally, in this task, we persist the ingested data with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">write</span></strong><span class="koboSpan" id="kobo.283.1"> function to disk storage in </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">delta</span></strong><span class="koboSpan" id="kobo.285.1"> format for use by the next steps of the workflow. </span><span class="koboSpan" id="kobo.285.2">As we will parallelize </span><a id="_idIndexMarker773"/><span class="koboSpan" id="kobo.286.1">the workflow tasks in the future, and to avoid multiple parallel writes to the same disk location, we store the data for this specific run in its own table appended with </span><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">runid</span></strong><span class="koboSpan" id="kobo.288.1">. </span><span class="koboSpan" id="kobo.288.2">Note as well how we used the term </span><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">bronze</span></strong><span class="koboSpan" id="kobo.290.1"> in the name. </span><span class="koboSpan" id="kobo.290.2">This corresponds to the </span><strong class="bold"><span class="koboSpan" id="kobo.291.1">medallion</span></strong><span class="koboSpan" id="kobo.292.1"> approach, which </span><a id="_idIndexMarker774"/><span class="koboSpan" id="kobo.293.1">we discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.294.1">Data processing and storage</span></em><span class="koboSpan" id="kobo.295.1"> section of </span><a href="B18568_04.xhtml#_idTextAnchor087"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.296.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.297.1">. </span><span class="koboSpan" id="kobo.297.2">Persisting the data to storage at this stage can come in handy when we are ingesting a lot of data. </span><span class="koboSpan" id="kobo.297.3">This makes it possible in the future to change and rerun the rest of the pipeline without having to re-ingest </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">the data.</span></span></p>
<p><span class="koboSpan" id="kobo.299.1">The status of the task is visible in the DAG view in Airflow as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.300.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.301.1">.1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.303.1">With the data ingested from the source and persisted, we can move on to the data </span><span class="No-Break"><span class="koboSpan" id="kobo.304.1">transformation stage.</span></span></p>
<h2 id="_idParaDest-176"><a id="_idTextAnchor177"/><span class="koboSpan" id="kobo.305.1">Data transformations</span></h2>
<p><span class="koboSpan" id="kobo.306.1">This stage corresponds to Airflow task </span><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">t2</span></strong><span class="koboSpan" id="kobo.308.1">, which calls the </span><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">transform_train_data</span></strong><span class="koboSpan" id="kobo.310.1"> function. </span><span class="koboSpan" id="kobo.310.2">As its </span><a id="_idIndexMarker775"/><span class="koboSpan" id="kobo.311.1">name suggests, this function transforms the training data into the right format for the upcoming </span><span class="No-Break"><span class="koboSpan" id="kobo.312.1">training stage.</span></span></p>
<p><span class="koboSpan" id="kobo.313.1">The code for this step is </span><span class="No-Break"><span class="koboSpan" id="kobo.314.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.315.1">
def </span><strong class="bold"><span class="koboSpan" id="kobo.316.1">transform_train_data</span></strong><span class="koboSpan" id="kobo.317.1">(_vars, **kwargs):
    sdf = spark.read.format("delta").load(
        f"/data/delta/ts-spark_ch9_</span><strong class="bold"><span class="koboSpan" id="kobo.318.1">bronze</span></strong><span class="koboSpan" id="kobo.319.1">_train_{_vars['runid']}"
    )
    sdf = sdf.selectExpr(
        "</span><strong class="bold"><span class="koboSpan" id="kobo.320.1">date as ds</span></strong><span class="koboSpan" id="kobo.321.1">",
        "</span><strong class="bold"><span class="koboSpan" id="kobo.322.1">cast</span></strong><span class="koboSpan" id="kobo.323.1">(</span><strong class="bold"><span class="koboSpan" id="kobo.324.1">daily_min_temperature</span></strong><span class="koboSpan" id="kobo.325.1"> as double) </span><strong class="bold"><span class="koboSpan" id="kobo.326.1">as y</span></strong><span class="koboSpan" id="kobo.327.1">"
    )
    sdf = sdf.</span><strong class="bold"><span class="koboSpan" id="kobo.328.1">dropna</span></strong><span class="koboSpan" id="kobo.329.1">()
    data_transform_count = sdf.</span><strong class="bold"><span class="koboSpan" id="kobo.330.1">count</span></strong><span class="koboSpan" id="kobo.331.1">()
    sdf.</span><strong class="bold"><span class="koboSpan" id="kobo.332.1">write</span></strong><span class="koboSpan" id="kobo.333.1">.format("</span><strong class="bold"><span class="koboSpan" id="kobo.334.1">delta</span></strong><span class="koboSpan" id="kobo.335.1">").mode("overwrite").save(
        f"/data/delta/ts-spark_ch9_</span><strong class="bold"><span class="koboSpan" id="kobo.336.1">silver</span></strong><span class="koboSpan" id="kobo.337.1">_train_{_vars['runid']}"
    )
    _vars['train_transform_count'] = data_transform_count
    return _vars</span></pre> <p><span class="koboSpan" id="kobo.338.1">We first </span><a id="_idIndexMarker776"/><span class="koboSpan" id="kobo.339.1">read the data from </span><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">bronze</span></strong><span class="koboSpan" id="kobo.341.1">, where it was stored by the previous task, </span><strong class="source-inline"><span class="koboSpan" id="kobo.342.1">t1</span></strong><span class="koboSpan" id="kobo.343.1">. </span><span class="koboSpan" id="kobo.343.2">This stored data can then be used as input to run the </span><span class="No-Break"><span class="koboSpan" id="kobo.344.1">current task.</span></span></p>
<p><span class="koboSpan" id="kobo.345.1">In this example, we do the following </span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">simple transformations:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.347.1">Column level: Rename the </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">date</span></strong><span class="koboSpan" id="kobo.349.1"> column </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">ds</span></strong></span></li>
<li><span class="koboSpan" id="kobo.352.1">Column level: Change </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">daily_min_temperature</span></strong><span class="koboSpan" id="kobo.354.1"> to the double data type (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">cast</span></strong><span class="koboSpan" id="kobo.356.1"> function) and rename it </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">y</span></strong></span></li>
<li><span class="koboSpan" id="kobo.359.1">DataFrame level: Remove all rows with missing values using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">dropna</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.361.1"> function</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.362.1">As in the previous stage, we want to collect metrics specific to this stage so that we can later report on the transformations. </span><span class="koboSpan" id="kobo.362.2">To do this, we count the number of rows in the DataFrame after </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">the transformations.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.364.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.365.1">This stage is likely to include several data checks and transformations, as discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.366.1">Data quality checks, cleaning, and transformations</span></em><span class="koboSpan" id="kobo.367.1"> section of </span><a href="B18568_05.xhtml#_idTextAnchor103"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.368.1">Chapter 5</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.369.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.370.1">Finally, in </span><a id="_idIndexMarker777"/><span class="koboSpan" id="kobo.371.1">this task, we persist the ingested data with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">write</span></strong><span class="koboSpan" id="kobo.373.1"> function to disk storage in </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">delta</span></strong><span class="koboSpan" id="kobo.375.1"> format for use by the next steps of the workflow. </span><span class="koboSpan" id="kobo.375.2">We call this data stage </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">silver</span></strong><span class="koboSpan" id="kobo.377.1">, as per the medallion approach </span><span class="No-Break"><span class="koboSpan" id="kobo.378.1">explained previously.</span></span></p>
<p><span class="koboSpan" id="kobo.379.1">Similarly to the previous tasks, we can see the task’s status in the DAG view in Airflow, as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.380.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.381.1">.1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.383.1">With the data curated and persisted, we can move on to the model </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">training stage.</span></span></p>
<h2 id="_idParaDest-177"><a id="_idTextAnchor178"/><span class="koboSpan" id="kobo.385.1">Model training and validation</span></h2>
<p><span class="koboSpan" id="kobo.386.1">This stage </span><a id="_idIndexMarker778"/><span class="koboSpan" id="kobo.387.1">is the longest in our example and corresponds to Airflow task </span><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">t3</span></strong><span class="koboSpan" id="kobo.389.1">, which calls the </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">train_and_log_model</span></strong><span class="koboSpan" id="kobo.391.1"> function. </span><span class="koboSpan" id="kobo.391.2">This function trains and validates a Prophet forecasting model using the training data from the previous stage. </span><span class="koboSpan" id="kobo.391.3">As we saw in </span><a href="B18568_07.xhtml#_idTextAnchor133"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.392.1">Chapter 7</span></em></span></a><span class="koboSpan" id="kobo.393.1">, choosing the right model involves a whole process, which we have simplified here to </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">a minimum.</span></span></p>
<p><span class="koboSpan" id="kobo.395.1">The code extract for this step is </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.397.1">
def </span><strong class="bold"><span class="koboSpan" id="kobo.398.1">train_and_log_model</span></strong><span class="koboSpan" id="kobo.399.1">(_vars, **kwargs):
    sdf = spark.read.format("delta").load(
        f"/data/delta/ts-spark_ch9_</span><strong class="bold"><span class="koboSpan" id="kobo.400.1">silver</span></strong><span class="koboSpan" id="kobo.401.1">_train_{_vars['runid']}"
    )
    pdf = sdf.toPandas()
    mlflow.</span><strong class="bold"><span class="koboSpan" id="kobo.402.1">set_experiment</span></strong><span class="koboSpan" id="kobo.403.1">(
        '</span><strong class="bold"><span class="koboSpan" id="kobo.404.1">ts-spark_ch9_data-ml-ops_time_series_prophet_train</span></strong><span class="koboSpan" id="kobo.405.1">'
    )
    mlflow.start_run()
    mlflow.</span><strong class="bold"><span class="koboSpan" id="kobo.406.1">log_param</span></strong><span class="koboSpan" id="kobo.407.1">("DAG_NAME", DAG_NAME)
    mlflow.log_param("TRAIN_START_DATE", _vars['START_DATE'])
…
    mlflow.</span><strong class="bold"><span class="koboSpan" id="kobo.408.1">log_metric</span></strong><span class="koboSpan" id="kobo.409.1">(
        'train_ingest_count', _vars['train_ingest_count'])
…
    model = Prophet().</span><strong class="bold"><span class="koboSpan" id="kobo.410.1">fit</span></strong><span class="koboSpan" id="kobo.411.1">(pdf)
…
    cv_metrics_name = [
        "mse", "rmse", "mae", "mdape", "smape", "coverage"]
    cv_params = </span><strong class="bold"><span class="koboSpan" id="kobo.412.1">cross_validation</span></strong><span class="koboSpan" id="kobo.413.1">(
        …
    )
    _cv_metrics = </span><strong class="bold"><span class="koboSpan" id="kobo.414.1">performance_metrics</span></strong><span class="koboSpan" id="kobo.415.1">(cv_params)
    cv_metrics = {
        n: _cv_metrics[n].mean() for n in cv_metrics_name}
…
    signature = </span><strong class="bold"><span class="koboSpan" id="kobo.416.1">infer_signature</span></strong><span class="koboSpan" id="kobo.417.1">(train, predictions)
    mlflow.prophet.</span><strong class="bold"><span class="koboSpan" id="kobo.418.1">log_model</span></strong><span class="koboSpan" id="kobo.419.1">(
        model, artifact_path=ARTIFACT_DIR,
        </span><strong class="bold"><span class="koboSpan" id="kobo.420.1">signature</span></strong><span class="koboSpan" id="kobo.421.1">=signature, registered_model_name=model_name,)
    mlflow.log_params(param)
    mlflow.log_metrics(cv_metrics)
…
    mlflow.end_run()
    return _vars</span></pre> <p><span class="koboSpan" id="kobo.422.1">In this </span><a id="_idIndexMarker779"/><span class="koboSpan" id="kobo.423.1">code example, we do </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">the following:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.425.1">We first read the data from </span><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">silver</span></strong><span class="koboSpan" id="kobo.427.1">, where it was stored by the previous task, </span><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">t2</span></strong><span class="koboSpan" id="kobo.429.1">. </span><span class="koboSpan" id="kobo.429.2">Then, we can run the current task using the stored data </span><span class="No-Break"><span class="koboSpan" id="kobo.430.1">as input.</span></span></li>
<li><span class="koboSpan" id="kobo.431.1">MLflow Tracking Server is used to save all the parameters and metrics for each run. </span><span class="koboSpan" id="kobo.431.2">We group them under an experiment called </span><strong class="source-inline"><span class="koboSpan" id="kobo.432.1">ts-spark_ch9_data-ml-ops_time_series_prophet_train</span></strong><span class="koboSpan" id="kobo.433.1"> and use </span><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">log_param</span></strong><span class="koboSpan" id="kobo.435.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">log_metric</span></strong><span class="koboSpan" id="kobo.437.1"> functions to capture the parameters and metrics gathered so far in </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">the run.</span></span></li>
<li><span class="koboSpan" id="kobo.439.1">We then train the Prophet model with the training data using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.440.1">fit</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.441.1"> function.</span></span></li>
<li><span class="koboSpan" id="kobo.442.1">As a model validation step, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">cross_validation</span></strong><span class="koboSpan" id="kobo.444.1"> function and retrieve the corresponding metrics with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">performance_metrics</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.446.1"> function.</span></span></li>
<li><span class="koboSpan" id="kobo.447.1">The final step is to log the model to the MLflow Model Registry, using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">log_model</span></strong><span class="koboSpan" id="kobo.449.1"> function, and all the related training and validation metrics with MLflow. </span><span class="koboSpan" id="kobo.449.2">Note that we log the model signature as a best practice to document the model in the MLflow </span><span class="No-Break"><span class="koboSpan" id="kobo.450.1">Model Registry.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.451.1">We can see the task’s status in the DAG view in Airflow, as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.452.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.453.1">.1</span></em><span class="koboSpan" id="kobo.454.1">. </span><span class="koboSpan" id="kobo.454.2">The logged parameters and metrics are visible in MLflow Tracking server, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.455.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.456.1">.4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer141">
<span class="koboSpan" id="kobo.458.1"><img alt="" src="image/B18568_09_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.459.1">Figure 9.4: MLflow experiment tracking (training)</span></p>
<p><span class="koboSpan" id="kobo.460.1">The model </span><a id="_idIndexMarker780"/><span class="koboSpan" id="kobo.461.1">saved in the MLflow Model Registry is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.462.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.463.1">.5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.464.1">.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer142">
<span class="koboSpan" id="kobo.465.1"><img alt="" src="image/B18568_09_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.466.1">Figure 9.5: MLflow Model Registry</span></p>
<p><span class="koboSpan" id="kobo.467.1">After the conclusion of the model training stage, we can progress to the next stage, where we will use the trained model to </span><span class="No-Break"><span class="koboSpan" id="kobo.468.1">do forecasting.</span></span></p>
<h2 id="_idParaDest-178"><a id="_idTextAnchor179"/><span class="koboSpan" id="kobo.469.1">Forecasting</span></h2>
<p><span class="koboSpan" id="kobo.470.1">This stage </span><a id="_idIndexMarker781"/><span class="koboSpan" id="kobo.471.1">corresponds to Airflow task </span><strong class="source-inline"><span class="koboSpan" id="kobo.472.1">t4</span></strong><span class="koboSpan" id="kobo.473.1">, which calls the </span><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">forecast</span></strong><span class="koboSpan" id="kobo.475.1"> function. </span><span class="koboSpan" id="kobo.475.2">As its name suggests, this function infers future values of the time series. </span><span class="koboSpan" id="kobo.475.3">While we have this task in the same workflow as the prior training tasks, it is common for the forecasting task to be in a separate inferencing pipeline. </span><span class="koboSpan" id="kobo.475.4">This separation allows for scheduling the training and inferencing at </span><span class="No-Break"><span class="koboSpan" id="kobo.476.1">different times.</span></span></p>
<p><span class="koboSpan" id="kobo.477.1">The code </span><a id="_idIndexMarker782"/><span class="koboSpan" id="kobo.478.1">for this step is </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.480.1">
def </span><strong class="bold"><span class="koboSpan" id="kobo.481.1">forecast</span></strong><span class="koboSpan" id="kobo.482.1">(_vars, **kwargs):
    # Load the model from the Model Registry
    model_uri = f"models:/{model_name}/{model_version}"
    _model = mlflow.prophet.load_model(model_uri)
    forecast = _model.</span><strong class="bold"><span class="koboSpan" id="kobo.483.1">predict</span></strong><span class="koboSpan" id="kobo.484.1">(
        _model.</span><strong class="bold"><span class="koboSpan" id="kobo.485.1">make_future_dataframe</span></strong><span class="koboSpan" id="kobo.486.1">(
            periods=365, include_history = False))
    sdf = spark.createDataFrame(forecast[
        ['ds', 'yhat', 'yhat_lower', 'yhat_upper']])
    sdf.</span><strong class="bold"><span class="koboSpan" id="kobo.487.1">write</span></strong><span class="koboSpan" id="kobo.488.1">.format("</span><strong class="bold"><span class="koboSpan" id="kobo.489.1">delta</span></strong><span class="koboSpan" id="kobo.490.1">").mode("overwrite").save(
        f"/data/delta/ts-spark_ch9_</span><strong class="bold"><span class="koboSpan" id="kobo.491.1">gold</span></strong><span class="koboSpan" id="kobo.492.1">_forecast_{_vars['runid']}")
    print(f"forecast:\n${forecast.tail(30)}")
    mlflow.end_run()
    return _vars</span></pre> <p><span class="koboSpan" id="kobo.493.1">We first load the model from the model registry, where it was stored by the previous task, </span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1">t3</span></strong><span class="koboSpan" id="kobo.495.1">. </span><span class="koboSpan" id="kobo.495.2">This model can then be used for forecasting in the </span><span class="No-Break"><span class="koboSpan" id="kobo.496.1">current task.</span></span></p>
<p><span class="koboSpan" id="kobo.497.1">In this example, we want to generate a forecast for 365 days in advance by calling </span><span class="No-Break"><span class="koboSpan" id="kobo.498.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.499.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">make_future_dataframe</span></strong><span class="koboSpan" id="kobo.501.1"> function to generate the </span><span class="No-Break"><span class="koboSpan" id="kobo.502.1">future period</span></span></li>
<li><span class="koboSpan" id="kobo.503.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.504.1">predict</span></strong><span class="koboSpan" id="kobo.505.1"> function to forecast for these </span><span class="No-Break"><span class="koboSpan" id="kobo.506.1">future times</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.507.1">Another approach to generating the future period is to get this as input from the user or another application calling the model. </span><span class="koboSpan" id="kobo.507.2">As for the 365-day forecasting horizon, this is a relatively long time to forecast. </span><span class="koboSpan" id="kobo.507.3">We discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.508.1">Forecasting</span></em><span class="koboSpan" id="kobo.509.1"> section of </span><a href="B18568_02.xhtml#_idTextAnchor044"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.510.1">Chapter 2</span></em></span></a><span class="koboSpan" id="kobo.511.1"> how a shorter forecasting horizon is likely to yield better forecasting accuracy. </span><span class="koboSpan" id="kobo.511.2">We have used a long </span><a id="_idIndexMarker783"/><span class="koboSpan" id="kobo.512.1">period in this example for practical reasons to showcase forecasting over a 5-year period, with 5 runs of 365 days each. </span><span class="koboSpan" id="kobo.512.2">These runs were explained in the earlier </span><em class="italic"><span class="koboSpan" id="kobo.513.1">Simulation and runs</span></em><span class="koboSpan" id="kobo.514.1"> section. </span><span class="koboSpan" id="kobo.514.2">Moving beyond the requirement of the example here, keep the forecasting horizon shorter relative to the span of the training dataset and the level </span><span class="No-Break"><span class="koboSpan" id="kobo.515.1">of granularity.</span></span></p>
<p><span class="koboSpan" id="kobo.516.1">Finally, in this task, we persist the forecasted data with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">write</span></strong><span class="koboSpan" id="kobo.518.1"> function to disk storage in </span><strong class="source-inline"><span class="koboSpan" id="kobo.519.1">delta</span></strong><span class="koboSpan" id="kobo.520.1"> format for use by the next steps of the workflow. </span><span class="koboSpan" id="kobo.520.2">We call this data stage </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">gold</span></strong><span class="koboSpan" id="kobo.522.1"> as per the medallion approach explained previously. </span><span class="koboSpan" id="kobo.522.2">This delta table, where the forecasting outcome is stored, is also known as the </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">inference table.</span></span></p>
<p><span class="koboSpan" id="kobo.524.1">With the forecasts persisted, we can move on to the model </span><span class="No-Break"><span class="koboSpan" id="kobo.525.1">evaluation stage.</span></span></p>
<h2 id="_idParaDest-179"><a id="_idTextAnchor180"/><span class="koboSpan" id="kobo.526.1">Model evaluation</span></h2>
<p><span class="koboSpan" id="kobo.527.1">This stage </span><a id="_idIndexMarker784"/><span class="koboSpan" id="kobo.528.1">corresponds to Airflow </span><a id="_idIndexMarker785"/><span class="koboSpan" id="kobo.529.1">tasks </span><strong class="source-inline"><span class="koboSpan" id="kobo.530.1">t5</span></strong><span class="koboSpan" id="kobo.531.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.532.1">t6</span></strong><span class="koboSpan" id="kobo.533.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.534.1">t7</span></strong><span class="koboSpan" id="kobo.535.1">, which call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.536.1">ingest_eval_data</span></strong><span class="koboSpan" id="kobo.537.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.538.1">transform_eval_data</span></strong><span class="koboSpan" id="kobo.539.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.540.1">eval_forecast</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.541.1">functions respectively.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.542.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.543.1">In a </span><a id="_idIndexMarker786"/><span class="koboSpan" id="kobo.544.1">production environment, we want to monitor the accuracy of our model’s forecast against real data so that we can detect when the model is </span><a id="_idIndexMarker787"/><span class="koboSpan" id="kobo.545.1">not accurate enough and needs retraining. </span><span class="koboSpan" id="kobo.545.2">In the example here, we have these tasks in the same workflow as the prior forecasting task to keep the example simple enough to fit within this chapter. </span><span class="koboSpan" id="kobo.545.3">These tasks will be a separately scheduled workflow, which will be executed a posteriori of the event being forecasted. </span><span class="koboSpan" id="kobo.545.4">In the example, we are simulating the post-event evaluation by using the data points following the </span><span class="No-Break"><span class="koboSpan" id="kobo.546.1">training data.</span></span></p>
<p><span class="koboSpan" id="kobo.547.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.548.1">ingest_eval_data</span></strong><span class="koboSpan" id="kobo.549.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.550.1">transform_eval_data</span></strong><span class="koboSpan" id="kobo.551.1"> functions are very similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.552.1">ingest_train_data</span></strong><span class="koboSpan" id="kobo.553.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">transform_train_data</span></strong><span class="koboSpan" id="kobo.555.1"> functions, which we have seen in the previous sections. </span><span class="koboSpan" id="kobo.555.2">The main difference, as the name suggests, is that they operate on the evaluation and training </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">data respectively.</span></span></p>
<p><span class="koboSpan" id="kobo.557.1">We will </span><a id="_idIndexMarker788"/><span class="koboSpan" id="kobo.558.1">focus on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.559.1">eval_forecast</span></strong><span class="koboSpan" id="kobo.560.1"> function in this section, with the code extract </span><span class="No-Break"><span class="koboSpan" id="kobo.561.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.562.1">
def </span><strong class="bold"><span class="koboSpan" id="kobo.563.1">eval_forecast</span></strong><span class="koboSpan" id="kobo.564.1">(_vars, **kwargs):
    sdf = spark.read.format("delta").load(
        f"/data/delta/ts-spark_ch9_</span><strong class="bold"><span class="koboSpan" id="kobo.565.1">silver</span></strong><span class="koboSpan" id="kobo.566.1">_eval_{_vars['runid']}")
    sdf_forecast = spark.read.format("delta").load(
        f"/data/delta/ts-spark_ch9_</span><strong class="bold"><span class="koboSpan" id="kobo.567.1">gold</span></strong><span class="koboSpan" id="kobo.568.1">_forecast_{_vars['runid']}")
    sdf_eval = sdf.</span><strong class="bold"><span class="koboSpan" id="kobo.569.1">join</span></strong><span class="koboSpan" id="kobo.570.1">(sdf_forecast, 'ds', "inner")
…
    evaluator = </span><strong class="bold"><span class="koboSpan" id="kobo.571.1">RegressionEvaluator</span></strong><span class="koboSpan" id="kobo.572.1">(
        labelCol='y', predictionCol='yhat', metricName='rmse')
    eval_rmse = evaluator.evaluate(sdf_eval)
…
    mlflow.set_experiment('</span><strong class="bold"><span class="koboSpan" id="kobo.573.1">ts-spark_ch9_data-ml-ops_time_series_prophet_eval</span></strong><span class="koboSpan" id="kobo.574.1">')
    mlflow.start_run()
    mlflow.</span><strong class="bold"><span class="koboSpan" id="kobo.575.1">log_param</span></strong><span class="koboSpan" id="kobo.576.1">("DAG_NAME", DAG_NAME)
    mlflow.log_param("EVAL_START_DATE", _vars['START_DATE'])
…
    mlflow.</span><strong class="bold"><span class="koboSpan" id="kobo.577.1">log_metric</span></strong><span class="koboSpan" id="kobo.578.1">('eval_rmse', _vars['eval_rmse'])
    mlflow.end_run()
    return _vars</span></pre> <p><span class="koboSpan" id="kobo.579.1">In this </span><a id="_idIndexMarker789"/><span class="koboSpan" id="kobo.580.1">code example, we do </span><span class="No-Break"><span class="koboSpan" id="kobo.581.1">the following:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.582.1">We first read the evaluation data from </span><strong class="source-inline"><span class="koboSpan" id="kobo.583.1">silver</span></strong><span class="koboSpan" id="kobo.584.1">, where it was stored by the previous task, </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">t6</span></strong><span class="koboSpan" id="kobo.586.1">. </span><span class="koboSpan" id="kobo.586.2">We also read the forecasted data from </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">gold</span></strong><span class="koboSpan" id="kobo.588.1">, where it was stored earlier by the forecasting task, </span><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">t4</span></strong><span class="koboSpan" id="kobo.590.1">. </span><span class="koboSpan" id="kobo.590.2">We join both datasets with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">join</span></strong><span class="koboSpan" id="kobo.592.1"> function so that we can compare the forecasts to </span><span class="No-Break"><span class="koboSpan" id="kobo.593.1">the actuals.</span></span></li>
<li><span class="koboSpan" id="kobo.594.1">In this </span><a id="_idIndexMarker790"/><span class="koboSpan" id="kobo.595.1">example, we use </span><strong class="bold"><span class="koboSpan" id="kobo.596.1">Root Mean Squared Error</span></strong><span class="koboSpan" id="kobo.597.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.598.1">RMSE</span></strong><span class="koboSpan" id="kobo.599.1">) as the evaluation metric. </span><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">RegressionEvaluator</span></strong><span class="koboSpan" id="kobo.601.1"> from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">pyspark.ml.evaluation</span></strong><span class="koboSpan" id="kobo.603.1"> library is used to do </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">the calculation.</span></span></li>
<li><span class="koboSpan" id="kobo.605.1">As a final step, MLflow Tracking Server is used to save all the parameters and metrics for each run. </span><span class="koboSpan" id="kobo.605.2">We group them under an experiment called </span><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">ts-spark_ch9_data-ml-ops_time_series_prophet_eval</span></strong><span class="koboSpan" id="kobo.607.1"> and use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.608.1">log_param</span></strong><span class="koboSpan" id="kobo.609.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.610.1">log_metric</span></strong><span class="koboSpan" id="kobo.611.1"> functions to capture the parameters and metrics gathered so far in </span><span class="No-Break"><span class="koboSpan" id="kobo.612.1">the run.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.613.1">We can see the task’s status in the DAG view in Airflow, as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.614.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.615.1">.1</span></em><span class="koboSpan" id="kobo.616.1">. </span><span class="koboSpan" id="kobo.616.2">The logged parameters and metrics are visible in MLflow Tracking Server, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.617.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.618.1">.6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer143">
<span class="koboSpan" id="kobo.620.1"><img alt="" src="image/B18568_09_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.621.1">Figure 9.6: MLflow experiment tracking (evaluation)</span></p>
<p><span class="koboSpan" id="kobo.622.1">As with </span><a id="_idIndexMarker791"/><span class="koboSpan" id="kobo.623.1">the training experiment tracking shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.624.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.625.1">.4</span></em><span class="koboSpan" id="kobo.626.1">, we can see in the evaluation experiment in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.627.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.628.1">.6</span></em><span class="koboSpan" id="kobo.629.1"> the ingest, transform, and forecast data counts, as well as the </span><span class="No-Break"><span class="koboSpan" id="kobo.630.1">evaluation RMSE.</span></span></p>
<p><span class="koboSpan" id="kobo.631.1">With this concluding the model evaluation stage, we have seen the end-to-end workflow example. </span><span class="koboSpan" id="kobo.631.2">In the next section, we will cover the monitoring and reporting part of </span><span class="No-Break"><span class="koboSpan" id="kobo.632.1">the example.</span></span></p>
<h1 id="_idParaDest-180"><a id="_idTextAnchor181"/><span class="koboSpan" id="kobo.633.1">Monitoring and reporting</span></h1>
<p><span class="koboSpan" id="kobo.634.1">The workflows </span><a id="_idIndexMarker792"/><span class="koboSpan" id="kobo.635.1">we covered in the previous section are the backend processes in our end-to-end time series analysis example. </span><span class="koboSpan" id="kobo.635.2">In this section, we will cover the operational monitoring of the runs and the end user reporting of the </span><span class="No-Break"><span class="koboSpan" id="kobo.636.1">forecasting outcome.</span></span></p>
<h2 id="_idParaDest-181"><a id="_idTextAnchor182"/><span class="koboSpan" id="kobo.637.1">Monitoring</span></h2>
<p><span class="koboSpan" id="kobo.638.1">The work </span><a id="_idIndexMarker793"/><span class="koboSpan" id="kobo.639.1">to collect the metrics has been done as part of the code executed by the workflows we have seen in this chapter. </span><span class="koboSpan" id="kobo.639.2">Our focus in this section is on the visualizations to monitor the workflows and </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">the metrics.</span></span></p>
<h3><span class="koboSpan" id="kobo.641.1">Workflow</span></h3>
<p><span class="koboSpan" id="kobo.642.1">Starting with </span><a id="_idIndexMarker794"/><span class="koboSpan" id="kobo.643.1">the workflow, as we have seen in </span><em class="italic"><span class="koboSpan" id="kobo.644.1">Figures 9.1</span></em><span class="koboSpan" id="kobo.645.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.646.1">9.2</span></em><span class="koboSpan" id="kobo.647.1">, the Airflow DAG shows the status of the runs. </span><span class="koboSpan" id="kobo.647.2">In case a task fails, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.648.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.649.1">.7</span></em><span class="koboSpan" id="kobo.650.1">, we can select the failed task in Airflow and inspect the event log and logs </span><span class="No-Break"><span class="koboSpan" id="kobo.651.1">to troubleshoot.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer144">
<span class="koboSpan" id="kobo.652.1"><img alt="" src="image/B18568_09_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.653.1">Figure 9.7: Airflow DAG with failed task</span></p>
<h3><span class="koboSpan" id="kobo.654.1">Training</span></h3>
<p><span class="koboSpan" id="kobo.655.1">We can </span><a id="_idIndexMarker795"/><span class="koboSpan" id="kobo.656.1">visualize the training metrics for a specific run in MLflow Tracking Server, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.657.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.658.1">.4</span></em><span class="koboSpan" id="kobo.659.1">. </span><span class="koboSpan" id="kobo.659.2">We can also monitor the metrics across multiple runs and compare them in a table, as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.660.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.661.1">.8</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.662.1">.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer145">
<span class="koboSpan" id="kobo.663.1"><img alt="" src="image/B18568_09_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.664.1">Figure 9.8: MLflow experiments (training) – select and compare</span></p>
<p><span class="koboSpan" id="kobo.665.1">By selecting the five runs of our </span><strong class="source-inline"><span class="koboSpan" id="kobo.666.1">_runall</span></strong><span class="koboSpan" id="kobo.667.1"> workflow and clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.668.1">Compare</span></strong><span class="koboSpan" id="kobo.669.1"> button as in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.670.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.671.1">.8</span></em><span class="koboSpan" id="kobo.672.1">, we can create a scatter plot as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.673.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.674.1">.9</span></em><span class="koboSpan" id="kobo.675.1">. </span><span class="koboSpan" id="kobo.675.2">This allows us to see the </span><a id="_idIndexMarker796"/><span class="koboSpan" id="kobo.676.1">details for a specific run as well by hovering the mouse pointer over a data point in </span><span class="No-Break"><span class="koboSpan" id="kobo.677.1">the graph.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer146">
<span class="koboSpan" id="kobo.678.1"><img alt="" src="image/B18568_09_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.679.1">Figure 9.9: Training – plot by runs with details</span></p>
<p><span class="koboSpan" id="kobo.680.1">An interesting metric to monitor is the count of training data transformed and ready for training, as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.681.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.682.1">.10</span></em><span class="koboSpan" id="kobo.683.1">. </span><span class="koboSpan" id="kobo.683.2">We can see here that the first four runs had fewer data points for training than the </span><span class="No-Break"><span class="koboSpan" id="kobo.684.1">last run.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer147">
<span class="koboSpan" id="kobo.685.1"><img alt="" src="image/B18568_09_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.686.1">Figure 9.10: Training – transform count by runs</span></p>
<p><span class="koboSpan" id="kobo.687.1">We can similarly monitor the RMSE for each training run, as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.688.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.689.1">.11</span></em><span class="koboSpan" id="kobo.690.1">. </span><span class="koboSpan" id="kobo.690.2">We can see here that the model accuracy has improved (lower RMSE) in the last two runs. </span><span class="koboSpan" id="kobo.690.3">If the accuracy had dropped instead, then the question from an operational point of view would have been whether this drop is acceptable or there is a need to develop another model. </span><span class="koboSpan" id="kobo.690.4">In this situation, this decision is dependent on your specific requirement and what was </span><a id="_idIndexMarker797"/><span class="koboSpan" id="kobo.691.1">agreed as an acceptable drop </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">in accuracy.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer148">
<span class="koboSpan" id="kobo.693.1"><img alt="" src="image/B18568_09_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.694.1">Figure 9.11: Training – RMSE by runs</span></p>
<p><span class="koboSpan" id="kobo.695.1">After the model has been trained and is used for forecasting, we can evaluate the model’s forecasted values against actuals. </span><span class="koboSpan" id="kobo.695.2">We will cover the monitoring of the evaluation </span><span class="No-Break"><span class="koboSpan" id="kobo.696.1">metrics next.</span></span></p>
<h3><span class="koboSpan" id="kobo.697.1">Evaluation</span></h3>
<p><span class="koboSpan" id="kobo.698.1">We can </span><a id="_idIndexMarker798"/><span class="koboSpan" id="kobo.699.1">visualize the evaluation metrics for a specific run in MLflow Tracking Server, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.700.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.701.1">.6</span></em><span class="koboSpan" id="kobo.702.1">. </span><span class="koboSpan" id="kobo.702.2">We can also monitor the metrics across multiple runs and compare them in a table, as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.703.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.704.1">.12</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.705.1">.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer149">
<span class="koboSpan" id="kobo.706.1"><img alt="" src="image/B18568_09_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.707.1">Figure 9.12: MLflow experiments (evaluation) – select and compare</span></p>
<p><span class="koboSpan" id="kobo.708.1">By selecting the five runs of our </span><strong class="source-inline"><span class="koboSpan" id="kobo.709.1">_runall</span></strong><span class="koboSpan" id="kobo.710.1"> workflow and clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.711.1">Compare</span></strong><span class="koboSpan" id="kobo.712.1"> button as in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.713.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.714.1">.12</span></em><span class="koboSpan" id="kobo.715.1">, we can create a scatter plot as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.716.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.717.1">.13</span></em><span class="koboSpan" id="kobo.718.1">. </span><span class="koboSpan" id="kobo.718.2">This allows us to also see the details for a specific run by hovering the mouse pointer over a data point in </span><span class="No-Break"><span class="koboSpan" id="kobo.719.1">the graph.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer150">
<span class="koboSpan" id="kobo.720.1"><img alt="" src="image/B18568_09_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.721.1">Figure 9.13: Evaluation – RMSE by runs with details</span></p>
<p><span class="koboSpan" id="kobo.722.1">An interesting </span><a id="_idIndexMarker799"/><span class="koboSpan" id="kobo.723.1">metric to monitor is the count of forecasted data points, as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.724.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.725.1">.14</span></em><span class="koboSpan" id="kobo.726.1">. </span><span class="koboSpan" id="kobo.726.2">We can see here that all the runs had the expected number of data points, except the fourth run, having one less. </span><span class="koboSpan" id="kobo.726.3">This can be explained by the fact that the evaluation dataset missed one data point during this </span><span class="No-Break"><span class="koboSpan" id="kobo.727.1">time period.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer151">
<span class="koboSpan" id="kobo.728.1"><img alt="" src="image/B18568_09_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.729.1">Figure 9.14: Evaluation – forecast count by runs</span></p>
<p><span class="koboSpan" id="kobo.730.1">We can similarly monitor the RMSE for each evaluation run, as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.731.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.732.1">.13</span></em><span class="koboSpan" id="kobo.733.1">. </span><span class="koboSpan" id="kobo.733.2">We can see here that the model accuracy dropped gradually (higher RMSE) until the fourth run and then improved in the last run. </span><span class="koboSpan" id="kobo.733.3">If the drop had persisted instead, the question from an operational point of view would have been whether this drop is acceptable or there is a need to develop another model. </span><span class="koboSpan" id="kobo.733.4">This decision is dependent on your specific requirement and what has been agreed as an acceptable drop </span><span class="No-Break"><span class="koboSpan" id="kobo.734.1">in accuracy.</span></span></p>
<p><span class="koboSpan" id="kobo.735.1">This concludes the section on monitoring. </span><span class="koboSpan" id="kobo.735.2">While using MLflow was sufficient for the example here, most organizations have dedicated monitoring solutions into which MLflow metrics can be integrated. </span><span class="koboSpan" id="kobo.735.3">These solutions also include alerting capabilities, which we have not </span><span class="No-Break"><span class="koboSpan" id="kobo.736.1">covered here.</span></span></p>
<p><span class="koboSpan" id="kobo.737.1">We have </span><a id="_idIndexMarker800"/><span class="koboSpan" id="kobo.738.1">explored the process to reach an outcome so far, but have not seen the outcome yet. </span><span class="koboSpan" id="kobo.738.2">In the next section, we will report on the </span><span class="No-Break"><span class="koboSpan" id="kobo.739.1">forecasting outcome.</span></span></p>
<h2 id="_idParaDest-182"><a id="_idTextAnchor183"/><span class="koboSpan" id="kobo.740.1">Reporting</span></h2>
<p><span class="koboSpan" id="kobo.741.1">We will </span><a id="_idIndexMarker801"/><span class="koboSpan" id="kobo.742.1">use a Jupyter notebook in this example to create a set of graphs to represent the forecasting outcome. </span><span class="koboSpan" id="kobo.742.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.743.1">ts-spark_ch9_data-ml-ops_results.ipynb</span></strong><span class="koboSpan" id="kobo.744.1"> notebook can be accessed from the local web location, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.745.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.746.1">.15</span></em><span class="koboSpan" id="kobo.747.1">. </span><span class="koboSpan" id="kobo.747.2">This Jupyter environment was deployed as part of the </span><em class="italic"><span class="koboSpan" id="kobo.748.1">Environment </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.749.1">setup</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.750.1"> section.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer152">
<span class="koboSpan" id="kobo.751.1"><img alt="" src="image/B18568_09_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.752.1">Figure 9.15: Reporting – notebook to create a graph</span></p>
<p><span class="koboSpan" id="kobo.753.1">After running the notebook, we can see at the end of the notebook the graph, as per </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.754.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.755.1">.16</span></em><span class="koboSpan" id="kobo.756.1">, of the forecasts (gray lines) and actuals (scatter plot) for the different runs. </span><span class="koboSpan" id="kobo.756.2">The forecast captures the seasonality well, and most of the actuals fall within the uncertainty intervals, which are set at 80% by default </span><span class="No-Break"><span class="koboSpan" id="kobo.757.1">on Prophet.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer153">
<span class="koboSpan" id="kobo.758.1"><img alt="" src="image/B18568_09_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.759.1">Figure 9.16: Reporting – actuals (scatter plot) compared to forecasts (gray lines)</span></p>
<p><span class="koboSpan" id="kobo.760.1">We can zoom </span><a id="_idIndexMarker802"/><span class="koboSpan" id="kobo.761.1">into specific runs as per </span><em class="italic"><span class="koboSpan" id="kobo.762.1">Figures 9.17</span></em><span class="koboSpan" id="kobo.763.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.764.1">9.18</span></em><span class="koboSpan" id="kobo.765.1">. </span><span class="koboSpan" id="kobo.765.2">These match with the RMSE values we saw in the earlier </span><em class="italic"><span class="koboSpan" id="kobo.766.1">Monitoring</span></em><span class="koboSpan" id="kobo.767.1"> section, as we will </span><span class="No-Break"><span class="koboSpan" id="kobo.768.1">detail next.</span></span></p>
<p><span class="koboSpan" id="kobo.769.1">As we can see in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.770.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.771.1">.13</span></em><span class="koboSpan" id="kobo.772.1">, the first run had the lowest RMSE. </span><span class="koboSpan" id="kobo.772.2">This is reflected in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.773.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.774.1">.17</span></em><span class="koboSpan" id="kobo.775.1">, with most actuals falling within the </span><span class="No-Break"><span class="koboSpan" id="kobo.776.1">forecasting interval.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer154">
<span class="koboSpan" id="kobo.777.1"><img alt="" src="image/B18568_09_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.778.1">Figure 9.17: Reporting – actuals compared to forecasts (run with lowest RMSE)</span></p>
<p><span class="koboSpan" id="kobo.779.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.780.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.781.1">.13</span></em><span class="koboSpan" id="kobo.782.1">, the fourth </span><a id="_idIndexMarker803"/><span class="koboSpan" id="kobo.783.1">run had the highest RMSE. </span><span class="koboSpan" id="kobo.783.2">This is reflected in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.784.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.785.1">.18</span></em><span class="koboSpan" id="kobo.786.1">, with many more actuals than in the first run falling outside the </span><span class="No-Break"><span class="koboSpan" id="kobo.787.1">forecasting interval.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer155">
<span class="koboSpan" id="kobo.788.1"><img alt="" src="image/B18568_09_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.789.1">Figure 9.18: Reporting – actuals compared to forecasts (run with highest RMSE)</span></p>
<p><span class="koboSpan" id="kobo.790.1">At this point, the output </span><a id="_idIndexMarker804"/><span class="koboSpan" id="kobo.791.1">of the Jupyter notebook can be exported as a report in several formats, such as HTML or PDF. </span><span class="koboSpan" id="kobo.791.2">While using Jupyter was sufficient for the example here, most organizations have reporting solutions into which the forecasting outcome can </span><span class="No-Break"><span class="koboSpan" id="kobo.792.1">be integrated.</span></span></p>
<h1 id="_idParaDest-183"><a id="_idTextAnchor184"/><span class="koboSpan" id="kobo.793.1">Additional considerations</span></h1>
<p><span class="koboSpan" id="kobo.794.1">We will </span><a id="_idIndexMarker805"/><span class="koboSpan" id="kobo.795.1">discuss here some of the additional considerations that apply when going to production, in addition to what we already covered in the example in </span><span class="No-Break"><span class="koboSpan" id="kobo.796.1">this chapter.</span></span></p>
<h2 id="_idParaDest-184"><a id="_idTextAnchor185"/><span class="koboSpan" id="kobo.797.1">Scaling</span></h2>
<p><span class="koboSpan" id="kobo.798.1">We </span><a id="_idIndexMarker806"/><span class="koboSpan" id="kobo.799.1">covered scaling extensively in </span><a href="B18568_08.xhtml#_idTextAnchor151"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.800.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.801.1">. </span><span class="koboSpan" id="kobo.801.2">The environment and workflows in this chapter can be scaled as well. </span><span class="koboSpan" id="kobo.801.3">At a high level, this can be achieved in the </span><span class="No-Break"><span class="koboSpan" id="kobo.802.1">following ways:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.803.1">Airflow server: scale up by adding more CPU and </span><span class="No-Break"><span class="koboSpan" id="kobo.804.1">memory resources</span></span></li>
<li><span class="koboSpan" id="kobo.805.1">Airflow DAG: run the tasks </span><span class="No-Break"><span class="koboSpan" id="kobo.806.1">in parallel</span></span></li>
<li><span class="koboSpan" id="kobo.807.1">Spark cluster: scale up by adding more CPU and </span><span class="No-Break"><span class="koboSpan" id="kobo.808.1">memory resources</span></span></li>
<li><span class="koboSpan" id="kobo.809.1">Spark cluster: scale out by adding </span><span class="No-Break"><span class="koboSpan" id="kobo.810.1">more workers</span></span></li>
<li><span class="koboSpan" id="kobo.811.1">Model: use Spark-enabled models or parallelize the use of pandas, as discussed in the </span><span class="No-Break"><span class="koboSpan" id="kobo.812.1">previous chapter</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.813.1">You can find </span><a id="_idIndexMarker807"/><span class="koboSpan" id="kobo.814.1">more information about Airflow DAGs, including parallel tasks, </span><span class="No-Break"><span class="koboSpan" id="kobo.815.1">here: </span></span><a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html"><span class="No-Break"><span class="koboSpan" id="kobo.816.1">https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html</span></span></a></p>
<p><span class="koboSpan" id="kobo.817.1">To relate </span><a id="_idIndexMarker808"/><span class="koboSpan" id="kobo.818.1">this to our Airflow DAG example in this chapter, we defined the tasks as sequential in the following way in the code </span><span class="No-Break"><span class="koboSpan" id="kobo.819.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.820.1">ts-spark_ch9_data-ml-ops_runall</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.821.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.822.1">
t1 &gt;&gt; t2 &gt;&gt; t3 &gt;&gt; t4 &gt;&gt; t5</span></pre> <p><span class="koboSpan" id="kobo.823.1">The code to run tasks </span><strong class="source-inline"><span class="koboSpan" id="kobo.824.1">t3</span></strong><span class="koboSpan" id="kobo.825.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.826.1">t4</span></strong><span class="koboSpan" id="kobo.827.1"> in parallel is </span><span class="No-Break"><span class="koboSpan" id="kobo.828.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.829.1">
t1 &gt;&gt; t2 &gt;&gt; [t3, t4] &gt;&gt; t5</span></pre> <p><span class="koboSpan" id="kobo.830.1">With regard to the considerations for scaling the Spark cluster, refer to </span><a href="B18568_03.xhtml#_idTextAnchor063"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.831.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.832.1"> and, more specifically, the </span><em class="italic"><span class="koboSpan" id="kobo.833.1">Driver and worker nodes</span></em><span class="koboSpan" id="kobo.834.1"> section, for a </span><span class="No-Break"><span class="koboSpan" id="kobo.835.1">detailed discussion.</span></span></p>
<h2 id="_idParaDest-185"><a id="_idTextAnchor186"/><span class="koboSpan" id="kobo.836.1">Model retraining</span></h2>
<p><span class="koboSpan" id="kobo.837.1">We already included retraining in our example workflow at every run using a sliding window </span><a id="_idIndexMarker809"/><span class="koboSpan" id="kobo.838.1">of the most recent data. </span><span class="koboSpan" id="kobo.838.2">In practice, and to optimize resource utilization, the retraining can be scheduled at a less frequent interval in its own separate workflow. </span><span class="koboSpan" id="kobo.838.3">We discussed tracking the model’s accuracy metrics across runs of the workflow in the </span><em class="italic"><span class="koboSpan" id="kobo.839.1">Monitoring</span></em><span class="koboSpan" id="kobo.840.1"> section. </span><span class="koboSpan" id="kobo.840.2">The trigger of this retraining workflow can be based on the accuracy dropping below a predefined threshold. </span><span class="koboSpan" id="kobo.840.3">The appropriate value for the threshold depends on your </span><span class="No-Break"><span class="koboSpan" id="kobo.841.1">specific requirements.</span></span></p>
<h2 id="_idParaDest-186"><a id="_idTextAnchor187"/><span class="koboSpan" id="kobo.842.1">Governance and security</span></h2>
<p><span class="koboSpan" id="kobo.843.1">In </span><a href="B18568_04.xhtml#_idTextAnchor087"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.844.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.845.1">, in the </span><em class="italic"><span class="koboSpan" id="kobo.846.1">From DataOps to ModelOps to DevOps</span></em><span class="koboSpan" id="kobo.847.1"> section, we discussed the </span><a id="_idIndexMarker810"/><span class="koboSpan" id="kobo.848.1">considerations for governance and security at various points. </span><span class="koboSpan" id="kobo.848.2">Securing your environment and production rollout is beyond the scope of this book. </span><span class="koboSpan" id="kobo.848.3">As these are key requirements, and we will not be going into further details here, we highly recommend referring to the following resources to secure the components used in </span><span class="No-Break"><span class="koboSpan" id="kobo.849.1">our example:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-3">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.850.1">Apache Spark</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://spark.apache.org/docs/latest/security.html"><span class="No-Break"><span class="koboSpan" id="kobo.851.1">https://spark.apache.org/docs/latest/security.html</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.852.1">MLflow</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://mlflow.org/docs/latest/auth/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.853.1">https://mlflow.org/docs/latest/auth/index.html</span></span></a></p>
<p><a href="https://github.com/mlflow/mlflow/security"><span class="No-Break"><span class="koboSpan" id="kobo.854.1">https://github.com/mlflow/mlflow/security</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.855.1">Airflow</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://airflow.apache.org/docs/apache-airflow/stable/security/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.856.1">https://airflow.apache.org/docs/apache-airflow/stable/security/index.html</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.857.1">Jupyter</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://jupyter.org/security"><span class="No-Break"><span class="koboSpan" id="kobo.858.1">https://jupyter.org/security</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.859.1">Docker</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://www.docker.com/blog/container-security-and-why-it-matters/"><span class="No-Break"><span class="koboSpan" id="kobo.860.1">https://www.docker.com/blog/container-security-and-why-it-matters/</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.861.1">Unity Catalog</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://www.unitycatalog.io/"><span class="No-Break"><span class="koboSpan" id="kobo.862.1">https://www.unitycatalog.io/</span></span></a></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.863.1">Table 9.1: Resources on security and governance for components in use</span></p>
<p><span class="koboSpan" id="kobo.864.1">This </span><a id="_idIndexMarker811"/><span class="koboSpan" id="kobo.865.1">concludes the section on the additional considerations before going </span><span class="No-Break"><span class="koboSpan" id="kobo.866.1">to production.</span></span></p>
<h1 id="_idParaDest-187"><a id="_idTextAnchor188"/><span class="koboSpan" id="kobo.867.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.868.1">In this chapter, we focused on the crucial phase of moving projects into production, especially given the challenges many projects face in achieving this transition and delivering measurable business results. </span><span class="koboSpan" id="kobo.868.2">We saw an example of an end-to-end workflow, covering the stages of data ingestion, storage, data transformations, model training and validation, forecasting, model evaluation, and monitoring. </span><span class="koboSpan" id="kobo.868.3">With this example, we brought together what we have learned in this book in view of planning for a </span><span class="No-Break"><span class="koboSpan" id="kobo.869.1">production rollout.</span></span></p>
<p><span class="koboSpan" id="kobo.870.1">In the next chapter, we will explore how to go further with Apache Spark for time series analysis by leveraging the advanced capabilities of a managed cloud platform for data </span><span class="No-Break"><span class="koboSpan" id="kobo.871.1">and AI.</span></span></p>
<h1 id="_idParaDest-188"><a id="_idTextAnchor189"/><span class="koboSpan" id="kobo.872.1">Join our community on Discord</span></h1>
<p><span class="koboSpan" id="kobo.873.1">Join our community’s Discord space for discussions with the authors and </span><span class="No-Break"><span class="koboSpan" id="kobo.874.1">other readers:</span></span></p>
<p><a href="https://packt.link/ds"><span class="No-Break"><span class="koboSpan" id="kobo.875.1">https://packt.link/ds</span></span></a></p>
<div>
<div class="IMG---Figure" id="_idContainer156">
<span class="koboSpan" id="kobo.876.1"><img alt="" src="image/ds_(1).jpg"/></span>
</div>
</div>
</div>
</body></html>