<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter" title="Chapter 3. Mastering the Notebook"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Mastering the Notebook</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Teaching programming in the notebook with IPython blocks</li><li class="listitem" style="list-style-type: disc">Converting an IPython notebook to other formats with nbconvert</li><li class="listitem" style="list-style-type: disc">Adding custom controls in the notebook toolbar</li><li class="listitem" style="list-style-type: disc">Customizing the CSS style in the notebook</li><li class="listitem" style="list-style-type: disc">Using interactive widgets – a piano in the notebook</li><li class="listitem" style="list-style-type: disc">Creating a custom JavaScript widget in the notebook – a spreadsheet editor for pandas</li><li class="listitem" style="list-style-type: disc">Processing webcam images in real time from the notebook</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec25"/>Introduction</h1></div></div></div><p>In this chapter, we will see many features of the notebook, including the interactive widgets that have been brought by IPython 2.0. As we have only seen basic features in the previous chapters, we will dive deeper into the architecture of the notebook here.</p><div class="section" title="What is the notebook?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec70"/>What is the notebook?</h2></div></div></div><p>The <a id="id318" class="indexterm"/>notebook was released in 2011, ten years after the creation of IPython. Its development has a <a id="id319" class="indexterm"/>long and complex history that is nicely summarized by Fernando Perez on his blog, <a class="ulink" href="http://blog.fperez.org/2012/01/ipython-notebook-historical.html">http://blog.fperez.org/2012/01/ipython-notebook-historical.html</a>. Inspired by mathematical software such as Maple, Mathematica, or Sage, the notebook really fostered the popularity of IPython.</p><p>By mixing together code, text, images, plots, hypertext links, and mathematical equations in a single document, the notebook brings reproducibility to interactive computing. The notebook, when used correctly, can radically change workflows in scientific computing. Prior to the notebook, one had to juggle between a text editor and an interactive prompt; now, one can stay focused within a single unified environment.</p><p>The notebook is not only a tool but also a powerful and robust architecture. Furthermore, this architecture is mostly language independent, so it's no longer tied to Python. The notebook defines a set of messaging protocols, APIs, and JavaScript code that can be used by other languages. In effect, we are now seeing <a id="id320" class="indexterm"/>non-Python kernels that can interact with the notebook <a id="id321" class="indexterm"/>such as IJulia, IHaskell, IRuby, and <a id="id322" class="indexterm"/>others.</p><p>At the SciPy <a id="id323" class="indexterm"/>conference in July 2014, the IPython developers even announced their decision to split the project into the following two parts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The new <span class="strong"><strong>Project</strong></span> <span class="strong"><strong>Jupyter</strong></span> <a id="id324" class="indexterm"/>will implement all language-independent parts: the notebook, the<a id="id325" class="indexterm"/> messaging protocol, and the overall architecture. For more details, visit <a class="ulink" href="http://jupyter.org">http://jupyter.org</a>.</li><li class="listitem" style="list-style-type: disc">IPython will be the name of the Python kernel.</li></ul></div><p>In this book, we do not make that semantic distinction, and we will use the term IPython to refer to the project as a whole (language-independent parts and Python kernel).</p></div><div class="section" title="The notebook ecosystem"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec71"/>The notebook ecosystem</h2></div></div></div><p>Notebooks<a id="id326" class="indexterm"/> are represented as <span class="strong"><strong>JavaScript Object</strong></span> <span class="strong"><strong>Notation</strong></span> (<span class="strong"><strong>JSON</strong></span>) documents. JSON<a id="id327" class="indexterm"/> is a language-independent, text-based file format for representing structured documents. As such, notebooks can be processed by any programming language, and they can be converted to other formats such as Markdown, HTML, LaTeX/PDF, and others.</p><p>An ecosystem is being built around the notebook, and we can expect to see more and more usage in the near future. For example, Google is working on bringing the IPython notebook to Google Drive for collaborative data analytics. Also, notebooks are being used to create slides, teaching materials, blog posts, research papers, and even books. In fact, this very book is entirely written in the notebook.</p><p>IPython 2.0<a id="id328" class="indexterm"/> introduced interactive widgets in the notebook. These widgets bring Python and the browser even closer. We can now create applications that implement bidirectional communication between the IPython kernel and the browser. Also, any JavaScript interactive library can be, in principle, integrated within the notebook. For example, the <code class="literal">D3.js</code> JavaScript visualization library is now being used by several Python projects to enable interactive visualization capabilities to the notebook. We are probably going to see many interesting uses of these interactive features in the near future.</p></div><div class="section" title="Architecture of the IPython notebook"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec72"/>Architecture of the IPython notebook</h2></div></div></div><p>IPython implements <a id="id329" class="indexterm"/>a two-process model, with a <span class="strong"><strong>kernel</strong></span> and a <span class="strong"><strong>client</strong></span>. The <a id="id330" class="indexterm"/>client is the interface offering the user the ability to send Python code to the kernel. The kernel executes the code and returns the result to the client for display. In the <span class="strong"><strong>Read-Evaluate-Print Loop</strong></span> (<span class="strong"><strong>REPL</strong></span>)<a id="id331" class="indexterm"/> terminology, the kernel implements the <span class="emphasis"><em>Evaluate</em></span>, whereas the client implements the <span class="emphasis"><em>Read</em></span> and the <span class="emphasis"><em>Print</em></span> of the process.</p><p>The client can be a Qt widget if we run the Qt console, or a browser if we run the notebook. In the notebook, the kernel receives entire cells at once, and thus has no notion of a notebook. There is a strong decoupling between the linear document containing the notebook, and the underlying kernel. This is a very strong constraint that may limit the possibilities, but that nevertheless leads to great simplicity and flexibility.</p><p>Another fundamental assumption in the whole architecture is that there can be at most one kernel connected to a notebook. However, IPython 3.0 offers the possibility of choosing the language kernel for any notebook.</p><p>It is important to keep these points in mind when thinking about new use-case scenarios for the notebook.</p><p>In the notebook, in addition to the Python kernel and the browser client, there is a Python server based on <a id="id332" class="indexterm"/><span class="strong"><strong>Tornado</strong></span> (<a class="ulink" href="http://www.tornadoweb.org">www.tornadoweb.org</a>). This process serves the HTML-based notebook interface.</p><p>All communication procedures between the different processes are implemented on top of the <span class="strong"><strong>ZeroMQ</strong></span><a id="id333" class="indexterm"/> (or <span class="strong"><strong>ZMQ</strong></span>) messaging protocol (<a class="ulink" href="http://zeromq.org">http://zeromq.org</a>). The notebook communicates with the underlying kernel using <span class="strong"><strong>WebSocket</strong></span>, a TCP-based protocol implemented in modern web browsers.</p><p>The browsers that officially support the notebook in IPython 2.x are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Chrome ≥ 13</li><li class="listitem" style="list-style-type: disc">Safari ≥ 5</li><li class="listitem" style="list-style-type: disc">Firefox ≥ 6</li></ul></div><p>The notebook should also work on Internet Explorer ≥ 10. These requirements are essentially those for WebSocket.</p><div class="section" title="Connecting multiple clients to one kernel"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec23"/>Connecting multiple clients to one kernel</h3></div></div></div><p>In a notebook, typing <code class="literal">%connect_info</code> in a <a id="id334" class="indexterm"/>cell gives the information we need to <a id="id335" class="indexterm"/>connect a <a id="id336" class="indexterm"/>new client (such as a Qt console) to the underlying kernel:</p><div class="informalexample"><pre class="programlisting">In [1]: %connect_info
{
  "stdin_port": 53978,
  "ip": "127.0.0.1", 
  "control_port": 53979, 
  "hb_port": 53980, 
  "signature_scheme": "hmac-sha256", 
  "key": "053...349", 
  "shell_port": 53976, 
  "transport": "tcp", 
  "iopub_port": 53977
}
Paste the above JSON code into a file, and connect with:
    $&gt; ipython &lt;app&gt; --existing &lt;file&gt;
or, if you are local, you can connect with just:
    $&gt; ipython &lt;app&gt; --existing kernel-6e0...b92.json
or even just:
    $&gt; ipython &lt;app&gt; --existing
if this is the most recent IPython session you have started.</pre></div><p>Here, <code class="literal">&lt;app&gt;</code> is <code class="literal">console</code>, <code class="literal">qtconsole</code>, or <code class="literal">notebook</code>.</p><p>It is even possible to have the kernel and the client running on different machines. You will find the instructions to run a public notebook server in the <a id="id337" class="indexterm"/>IPython documentation, available at <a class="ulink" href="http://ipython.org/ipython-doc/dev/notebook/public_server.html#running-a-public-notebook-server">http://ipython.org/ipython-doc/dev/notebook/public_server.html#running-a-public-notebook-server</a>.</p></div></div><div class="section" title="Security in notebooks"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec73"/>Security in notebooks</h2></div></div></div><p>It is possible for someone to<a id="id338" class="indexterm"/> put malicious code in an IPython notebook. Since notebooks<a id="id339" class="indexterm"/> may contain hidden JavaScript code in a cell output, it is theoretically possible for malicious code to execute surreptitiously when the user opens a notebook.</p><p>For this reason, IPython 2.0 introduced a security model where HTML and JavaScript code in a notebook can be either trusted or untrusted. Outputs generated by the user are always trusted. However, outputs that were already there when the user first opened an existing notebook are untrusted.</p><p>The security model is based on a cryptographic signature present in every notebook. This signature is generated using a secret key owned by every user.</p><p>You can find further references on the security model in the following section.</p></div><div class="section" title="References"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec74"/>References</h2></div></div></div><p>The following are some<a id="id340" class="indexterm"/> references about the notebook architecture:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The IPython two-process model, explained at <a class="ulink" href="http://ipython.org/ipython-doc/stable/overview.html#decoupled-two-process-model">http://ipython.org/ipython-doc/stable/overview.html#decoupled-two-process-model</a></li><li class="listitem" style="list-style-type: disc">Documentation of the notebook, available at <a class="ulink" href="http://ipython.org/ipython-doc/stable/interactive/notebook.html">http://ipython.org/ipython-doc/stable/interactive/notebook.html</a></li><li class="listitem" style="list-style-type: disc">Security in the notebook, described at <a class="ulink" href="http://ipython.org/ipython-doc/dev/notebook/security.html">http://ipython.org/ipython-doc/dev/notebook/security.html</a></li><li class="listitem" style="list-style-type: disc">The notebook server, described at <a class="ulink" href="http://ipython.org/ipython-doc/dev/interactive/public_server.html">http://ipython.org/ipython-doc/dev/interactive/public_server.html</a></li><li class="listitem" style="list-style-type: disc">The IPython messaging protocol, at <a class="ulink" href="http://ipython.org/ipython-doc/dev/development/messaging.html">http://ipython.org/ipython-doc/dev/development/messaging.html</a></li><li class="listitem" style="list-style-type: disc">Tutorial about how to write a custom kernel for the notebook, at <a class="ulink" href="http://andrew.gibiansky.com/blog/ipython/ipython-kernels/">http://andrew.gibiansky.com/blog/ipython/ipython-kernels/</a></li></ul></div><p>Here are a few (mostly experimental) kernels in non-Python languages<a id="id341" class="indexterm"/> for the notebook:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">IJulia, available at <a class="ulink" href="https://github.com/JuliaLang/IJulia.jl">https://github.com/JuliaLang/IJulia.jl</a></li><li class="listitem" style="list-style-type: disc">IRuby, available at <a class="ulink" href="https://github.com/isotope11/iruby">https://github.com/isotope11/iruby</a></li><li class="listitem" style="list-style-type: disc">IHaskell, available at <a class="ulink" href="https://github.com/gibiansky/IHaskell">https://github.com/gibiansky/IHaskell</a></li><li class="listitem" style="list-style-type: disc">IGo, available at <a class="ulink" href="https://github.com/takluyver/igo">https://github.com/takluyver/igo</a></li><li class="listitem" style="list-style-type: disc">IScala, available at <a class="ulink" href="https://github.com/mattpap/IScala">https://github.com/mattpap/IScala</a></li></ul></div></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Teaching programming in the notebook with IPython blocks"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Teaching programming in the notebook with IPython blocks</h1></div></div></div><p>The IPython notebook is not <a id="id342" class="indexterm"/>only a tool for <a id="id343" class="indexterm"/>scientific research and data analysis but also a great tool for teaching. In this recipe, we show a simple and fun Python library for teaching programming notions: <span class="strong"><strong>IPython Blocks</strong></span><a id="id344" class="indexterm"/> (available at <a class="ulink" href="http://ipythonblocks.org">http://ipythonblocks.org</a>). This library allows you or your students to create grids of colorful blocks. You can change the color and size of individual blocks, and you can even animate your grids. There are many basic technical notions you can illustrate with this tool. The visual aspect of this tool makes the learning process more effective and engaging.</p><p>In this recipe, we will notably perform the following tasks:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Illustrate matrix multiplication with an animation</li><li class="listitem" style="list-style-type: disc">Display an image as a block grid</li></ul></div><p>This recipe is partly inspired by the example at <a class="ulink" href="http://nbviewer.ipython.org/gist/picken19/b0034ba7ec690e89ea79">http://nbviewer.ipython.org/gist/picken19/b0034ba7ec690e89ea79</a>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec75"/>Getting ready</h2></div></div></div><p>You need to install IPython Blocks for this recipe. You can just type in a terminal <code class="literal">pip install ipythonblocks</code>. Note that you can also execute this shell command from the IPython notebook by prefixing this command with <code class="literal">!</code>.</p><div class="informalexample"><pre class="programlisting">In [1]: !pip install ipythonblocks</pre></div><p>For the last part of this recipe, you<a id="id345" class="indexterm"/> also need to install Pillow, available at <a class="ulink" href="http://pillow.readthedocs.org/en/latest/">http://pillow.readthedocs.org/en/latest/</a>; you will find more instructions in <a class="link" href="ch11.html" title="Chapter 11. Image and Audio Processing">Chapter 11</a>, <span class="emphasis"><em>Image and Audio Processing</em></span>. With Anaconda, you can execute <code class="literal">conda install pillow</code> in a terminal.</p><p>Finally, you need to download the <span class="emphasis"><em>Portrait</em></span> dataset from the book's website (<a class="ulink" href="https://github.com/ipython-books/cookbook-data">https://github.com/ipython-books/cookbook-data</a>) and extract it in the current directory. You can also play with your own images!</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec76"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we<a id="id346" class="indexterm"/> import some <a id="id347" class="indexterm"/>modules as follows:<div class="informalexample"><pre class="programlisting">In [1]: import time
        from IPython.display import clear_output
        from ipythonblocks import BlockGrid, colors</pre></div></li><li class="listitem">Now, we create a block grid with five columns and five rows, and we fill each block in purple:<div class="informalexample"><pre class="programlisting">In [2]: grid = BlockGrid(width=5, height=5,
                         fill=colors['Purple'])
        grid.show()</pre></div><div class="mediaobject"><img src="images/4818OS_03_01.jpg" alt="How to do it..."/></div></li><li class="listitem">We can <a id="id348" class="indexterm"/>access individual<a id="id349" class="indexterm"/> blocks with 2D indexing. This illustrates the indexing syntax in Python. We can also access an entire row or line with a <code class="literal">:</code> (colon). Each block is represented by an RGB color. The library comes with a handy dictionary of colors, assigning RGB tuples to standard color names as follows:<div class="informalexample"><pre class="programlisting">In [3]: grid[0,0] = colors['Lime']
        grid[-1,0] = colors['Lime']
        grid[:,-1] = colors['Lime']
        grid.show()</pre></div><div class="mediaobject"><img src="images/4818OS_03_02.jpg" alt="How to do it..."/></div></li><li class="listitem">Now, we are going to illustrate matrix multiplication, a fundamental notion in linear algebra. We will represent two (<code class="literal">n,n</code>) matrices, <code class="literal">A</code> (in cyan) and <code class="literal">B</code> (lime) aligned with <code class="literal">C = A B</code> (yellow). To do this, we use a small trick of creating a big white grid of size (<code class="literal">2n+1,2n+1</code>). The matrices <code class="literal">A</code>, <code class="literal">B</code>, and <code class="literal">C</code> are just views on parts of the grid.<div class="informalexample"><pre class="programlisting">In [4]: n = 5
        grid = BlockGrid(width=2*n+1, 
                         height=2*n+1, 
                         fill=colors['White'])
        A = grid[n+1:,:n]
        B = grid[:n,n+1:]
        C = grid[n+1:,n+1:]
        A[:,:] = colors['Cyan']
        B[:,:] = colors['Lime']
        C[:,:] = colors['Yellow']
        grid.show()</pre></div><div class="mediaobject"><img src="images/4818OS_03_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Let's turn to<a id="id350" class="indexterm"/> matrix multiplication<a id="id351" class="indexterm"/> itself. We perform a loop over all rows and columns, and we highlight the corresponding rows and columns in A and B that are multiplied together during the matrix product. We combine IPython's <code class="literal">clear_output()</code> method with <code class="literal">grid.show()</code> and <code class="literal">time.sleep()</code> (pause) to implement the animation as follows:<div class="informalexample"><pre class="programlisting">In [5]: for i in range(n):
            for j in range(n):
                # We reset the matrix colors.
                A[:,:] = colors['Cyan']
                B[:,:] = colors['Lime']
                C[:,:] = colors['Yellow']
                # We highlight the adequate rows
                # and columns in red.
                A[i,:] = colors['Red']
                B[:,j] = colors['Red']
                C[i,j] = colors['Red']
                # We animate the grid in the loop.
                clear_output()
                grid.show()
                time.sleep(0.25)</pre></div><div class="mediaobject"><img src="images/4818OS_03_04.jpg" alt="How to do it..."/></div></li><li class="listitem">Finally, we will<a id="id352" class="indexterm"/> display an<a id="id353" class="indexterm"/> image with IPython Blocks. We import the JPG image with <code class="literal">Image.open()</code> and we retrieve the data with <code class="literal">getdata()</code> as follows:<div class="informalexample"><pre class="programlisting">In [6]: from PIL import Image
        imdata = Image.open('data/photo.jpg').getdata()</pre></div></li><li class="listitem">Now, we create a <code class="literal">BlockGrid</code> instance with the appropriate number of rows and columns, and we set each block's color to the corresponding pixel's color in the image. We use a small block size, and we remove the lines between the blocks as follows:<div class="informalexample"><pre class="programlisting">In [7]: rows, cols = imdata.size
        grid = BlockGrid(width=rows, height=cols,
                         block_size=4, lines_on=False)
        for block, rgb in zip(grid, imdata):
            block.rgb = rgb
        grid.show()</pre></div><div class="mediaobject"><img src="images/4818OS_03_05.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec77"/>There's more...</h2></div></div></div><p>As demonstrated in this recipe, the notebook is an ideal platform for education activities at all levels.</p><p>This library has been developed prior to the interactive notebook features brought by IPython 2.0. We can now expect even more interactive developments.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Converting an IPython notebook to other formats with nbconvert"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec27"/>Converting an IPython notebook to other formats with nbconvert</h1></div></div></div><p>An IPython notebook is saved in a JSON text file. This<a id="id354" class="indexterm"/> file contains the entire contents of the notebook: text, code, and <a id="id355" class="indexterm"/>outputs. The matplotlib figures are encoded as base64 strings within the notebooks, resulting in standalone, but sometimes big, notebook files.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note17"/>Note</h3><p>JSON<a id="id356" class="indexterm"/> is a human-readable, text-based, open standard format that can represent structured data. Although derived from JavaScript, it is language independent. Its syntax bears some resemblance with Python dictionaries. JSON can be parsed in many languages including JavaScript and Python (the <code class="literal">json</code> module in Python's standard library).</p></div></div><p>IPython comes with a tool called <span class="strong"><strong>nbconvert</strong></span> that can convert notebooks to other formats: raw text, Markdown, HTML, LaTeX/PDF, and even slides with the <code class="literal">reveal.js</code> library. You will find more information about the different supported formats on the nbconvert documentation.</p><p>In this recipe, we will see how to manipulate the contents of a notebook and how to convert it to other formats.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec78"/>Getting ready</h2></div></div></div><p>You need to install<a id="id357" class="indexterm"/> pandoc, available at <a class="ulink" href="http://johnmacfarlane.net/pandoc/">http://johnmacfarlane.net/pandoc/</a>, which is a tool for converting files from one markup language to another.</p><p>To convert a notebook to PDF, you need a <a id="id358" class="indexterm"/>LaTeX distribution, which is available at <a class="ulink" href="http://latex-project.org/ftp.html">http://latex-project.org/ftp.html</a>. You also need to download the <span class="emphasis"><em>Notebook</em></span> dataset from the book's website (<a class="ulink" href="https://github.com/ipython-books/cookbook-data">https://github.com/ipython-books/cookbook-data</a>), and extract it in the current directory.</p><p>On Windows, you may need the <code class="literal">pywin32</code> package. If you use Anaconda, you can install it with <code class="literal">conda install pywin32</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec79"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's <a id="id359" class="indexterm"/>open the <code class="literal">test</code> notebook <a id="id360" class="indexterm"/>in the <code class="literal">data</code> folder. A notebook is just a plain text file (JSON), so we open it in the text mode (<code class="literal">r</code> mode) as follows:<div class="informalexample"><pre class="programlisting">In [1]: with open('data/test.ipynb', 'r') as f:
            contents = f.read()
        print(len(contents))
3787</pre></div><p>Here is an excerpt of the <code class="literal">test.ipynb</code> file:</p><div class="informalexample"><pre class="programlisting">{
 "metadata": {
  "celltoolbar": "Edit Metadata",
  "name": "",
  "signature": "sha256:50db..."
 },
 "nbformat": 3,
 "nbformat_minor": 0,
 "worksheets": [
  {
...
     "source": [
      "# First chapter"
     ]
    },
  ...
   ],
   "metadata": {}
  }
 ]
}</pre></div></li><li class="listitem">Now that we have loaded the notebook in a string, let's parse it with the <code class="literal">json</code> module as follows:<div class="informalexample"><pre class="programlisting">In [3]: import json
        nb = json.loads(contents)</pre></div></li><li class="listitem">Let's have a look at the keys in the notebook dictionary:<div class="informalexample"><pre class="programlisting">In [4]: print(nb.keys())
        print('nbformat ' + str(nb['nbformat']) + 
              '.' + str(nb['nbformat_minor']))
[u'nbformat', u'nbformat_minor', u'worksheets', u'metadata']
nbformat 3.0</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note18"/>Note</h3><p>The version of the notebook format is indicated in <code class="literal">nbformat</code> and <code class="literal">nbformat_minor</code>. Backwards-incompatible changes in the notebook format are to be expected in future versions of IPython. This recipe has been tested with the IPython 2.x branch and the notebook format v3.</p></div></div></li><li class="listitem">The main<a id="id361" class="indexterm"/> field is <code class="literal">worksheets</code>; there is only one by default. A worksheet contains a list of cells <a id="id362" class="indexterm"/>and some metadata. The <code class="literal">worksheets</code> field may disappear in a future version of the notebook format. Let's have a look at the contents of a worksheet:<div class="informalexample"><pre class="programlisting">In [5]: nb['worksheets'][0].keys()
Out[5]: [u'cells', u'metadata']</pre></div></li><li class="listitem">Each cell has a type, optional metadata, some contents (text or code), possibly one or several outputs, and other information. Let's look at a Markdown cell and a code cell:<div class="informalexample"><pre class="programlisting">In [6]: nb['worksheets'][0]['cells'][1]
Out[6]: {u'cell_type': u'markdown',
 u'metadata': {u'my_field': [u'value1', u'2405']},
               u'source': [u"Let's write ...:\n", ...]}
In [7]: nb['worksheets'][0]['cells'][2]
Out[7]: {u'cell_type': u'code',
         u'collapsed': False,
         u'input': [u'import numpy as np\n', ...],
         u'language': u'python',
         u'metadata': {},
         u'outputs': [
                      {u'metadata': {},
                       u'output_type': u'display_data',
                       u'png': u'iVB...mCC\n',
                       u'prompt_number': 1}]}</pre></div></li><li class="listitem">Once parsed, the notebook is represented as a Python dictionary. Manipulating it is therefore quite convenient in Python. Here, we count the number of Markdown and code cells as follows:<div class="informalexample"><pre class="programlisting">In [8]: cells = nb['worksheets'][0]['cells']
        nm = len([cell for cell in cells
                  if cell['cell_type'] == 'markdown'])
        nc = len([cell for cell in cells
                  if cell['cell_type'] == 'code'])
        print(("There are {nm} Markdown cells and "
               "{nc} code cells.").format(nm=nm, nc=nc))
There are 2 Markdown cells and 1 code cells.</pre></div></li><li class="listitem">Let's have a<a id="id363" class="indexterm"/> closer look <a id="id364" class="indexterm"/>at the image output of the cell with the matplotlib figure:<div class="informalexample"><pre class="programlisting">In [9]: png = cells[2]['outputs'][0]['png']
        cells[2]['outputs'][0]
Out[9]: {u'metadata': {},
         u'output_type': u'display_data',
         u'png': u'iVBORwoAAAANSUhE...ErAAAElTkQmCC\n'}</pre></div></li><li class="listitem">In general, there can be zero, one, or multiple outputs. Additionally, each output can have multiple representations. Here, the matplotlib figure has a PNG representation (the base64-encoded image) and a text representation (the internal representation of the figure).</li><li class="listitem">Now, we are going to use nbconvert to convert our text notebook to other formats. This tool can be used from the command line. Note that the API of nbconvert may change in future versions. Here, we convert the notebook to an HTML document as follows:<div class="informalexample"><pre class="programlisting">In [10]: !ipython nbconvert --to html data/test.ipynb
[NbConvertApp] Writing 187617 bytes to test.html</pre></div></li><li class="listitem">Let's display this document in an <code class="literal">&lt;iframe&gt;</code> (a small window showing an external HTML document within the notebook):<div class="informalexample"><pre class="programlisting">In [11]: from IPython.display import IFrame
         IFrame('test.html', 600, 200)</pre></div><div class="mediaobject"><img src="images/4818OS_03_06.jpg" alt="How to do it..."/></div></li><li class="listitem">We can also <a id="id365" class="indexterm"/>convert the<a id="id366" class="indexterm"/> notebook to LaTeX and PDF. In order to specify the title and author of the document, we need to extend the default LaTeX template. First, we create a file called <code class="literal">mytemplate.tplx</code> that extends the default <code class="literal">article.tplx</code> template provided by nbconvert. We specify the contents of the author and title blocks as follows:<div class="informalexample"><pre class="programlisting">In [12]: %%writefile mytemplate.tplx
         ((*- extends 'article.tplx' -*))
         
         ((* block author *))
         \author{Cyrille Rossant}
         ((* endblock author *))
         
         ((* block title *))
         \title{My document}
         ((* endblock title *))
Writing mytemplate.tplx</pre></div></li><li class="listitem">Then, we can run nbconvert by specifying our custom template as follows:<div class="informalexample"><pre class="programlisting">In [13]: !ipython nbconvert --to latex --template mytemplate data/test.ipynb
         !pdflatex test.tex
[NbConvertApp] PDF successfully created</pre></div><p>We used nbconvert to convert the notebook to LaTeX, and <code class="literal">pdflatex</code> (coming with our LaTeX distribution) to compile the LaTeX document to PDF. The following screenshot shows the PDF version of the notebook:</p><div class="mediaobject"><img src="images/4818OS_03_07.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec80"/>How it works...</h2></div></div></div><p>As we have <a id="id367" class="indexterm"/>seen in this recipe, an <code class="literal">.ipynb</code> file<a id="id368" class="indexterm"/> contains a structured representation of the notebook. This JSON file can be easily parsed and manipulated in Python.</p><p>nbconvert is a tool for converting a notebook to another format. The conversion can be customized in several ways. Here, we extended an existing template using <code class="literal">jinja2</code>, a templating package. You will find more information in the documentation of nbconvert.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec81"/>There's more...</h2></div></div></div><p>There is a free online service, <span class="strong"><strong>nbviewer</strong></span>, that lets us render IPython notebooks in HTML dynamically in the cloud. The idea is that we provide to nbviewer a URL to a raw notebook (in JSON), and we get a rendered HTML output. The main page of nbviewer<a id="id369" class="indexterm"/> (<a class="ulink" href="http://nbviewer.ipython.org">http://nbviewer.ipython.org</a>) contains a few examples.</p><p>This service is maintained by the IPython developers and is hosted on Rackspace<a id="id370" class="indexterm"/> (<a class="ulink" href="http://www.rackspace.com">www.rackspace.com</a>).</p><p>Here are some more references:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Documentation of<a id="id371" class="indexterm"/> nbconvert, at <a class="ulink" href="http://ipython.org/ipython-doc/dev/interactive/nbconvert.html">http://ipython.org/ipython-doc/dev/interactive/nbconvert.html</a></li><li class="listitem" style="list-style-type: disc">A list of conversion<a id="id372" class="indexterm"/> examples with nbconvert, at <a class="ulink" href="https://github.com/ipython/nbconvert-examples">https://github.com/ipython/nbconvert-examples</a></li><li class="listitem" style="list-style-type: disc">JSON on Wikipedia, available <a id="id373" class="indexterm"/>at <a class="ulink" href="http://en.wikipedia.org/wiki/JSON">http://en.wikipedia.org/wiki/JSON</a></li></ul></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Adding custom controls in the notebook toolbar"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec28"/>Adding custom controls in the notebook toolbar</h1></div></div></div><p>The CSS and <a id="id374" class="indexterm"/>JavaScript of the HTML notebook can be<a id="id375" class="indexterm"/> customized through the files in <code class="literal">~/.ipython/profile_default/static/custom</code>, where <code class="literal">~</code> is your home directory, and <code class="literal">default</code> is your IPython profile.</p><p>In this recipe, we will use these customization options to add a new button in the notebook toolbar that linearly renumbers all code cells.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec82"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we are going to inject JavaScript code directly in the notebook. This is useful for testing purposes, or if we don't want the changes to be permanent. The JavaScript code will be loaded with that notebook only. To do this, we can just use the <code class="literal">%%javascript</code> cell magic as follows:<div class="informalexample"><pre class="programlisting">In [1]: %%javascript
        // This function allows us to add buttons 
        // to the notebook toolbar.
        IPython.toolbar.add_buttons_group([
        {
            // The button's label.
            'label': 'renumber all code cells',
            
            // The button's icon.
            // See a list of Font-Awesome icons here:
            // http://fortawesome.github.io/Font-
            //                              Awesome/icons/
            'icon': 'icon-list-ol',
            
            // The callback function.
            'callback': function () {
                
                // We retrieve the lists of all cells.
                var cells = IPython.notebook.get_cells();
                
                // We only keep the code cells.
                cells = cells.filter(function(c)
                  {
                      return c instanceof IPython.CodeCell; 
                  })
                
                // We set the input prompt of all code 
                // cells.
                for (var i = 0; i &lt; cells.length; i++) {
                    cells[i].set_input_prompt(i + 1);
                }
            }
        }]);</pre></div></li><li class="listitem">Running the<a id="id376" class="indexterm"/> preceding code cell adds a <a id="id377" class="indexterm"/>button in the toolbar as shown in the following screenshot. Clicking on this button automatically updates the prompt numbers of all code cells.<div class="mediaobject"><img src="images/4818OS_03_08.jpg" alt="How to do it..."/><div class="caption"><p>Adding a Renumber toolbar button</p></div></div></li><li class="listitem">To make these changes permanent, that is, to add this button on every notebook in the current profile, we can open the <code class="literal">~/.ipython/profile_default/static/custom/custom.js</code> file and add the following lines of code:<div class="informalexample"><pre class="programlisting">$([IPython.events]).on('app_initialized.NotebookApp',
    function(){
        // Copy the JavaScript code (in step 1) here.
    });</pre></div><p>The preceding code will be automatically loaded in the notebook, and the renumber button will appear on top of every notebook in the current profile.</p></li></ol></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec83"/>There's more...</h2></div></div></div><p>The IPython notebook JavaScript API that allowed us to add a button to the notebook toolbar is still unstable at<a id="id378" class="indexterm"/> the time of writing. It may change at <a id="id379" class="indexterm"/>any time, and it is not well documented. This recipe has only been tested with IPython 2.0. You may nevertheless find a not-so-official and partial API documentation on this page: <a class="ulink" href="http://ipjsdoc.herokuapp.com">http://ipjsdoc.herokuapp.com</a>. </p><p>We should expect a more stable API in the future.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec84"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Customizing the CSS style in the notebook</em></span> recipe</li></ul></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Customizing the CSS style in the notebook"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec29"/>Customizing the CSS style in the notebook</h1></div></div></div><p>In this recipe, we show<a id="id380" class="indexterm"/> how to customize the CSS in the notebook interface and in an exported HTML notebook.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec85"/>Getting ready</h2></div></div></div><p>You are expected to know a bit<a id="id381" class="indexterm"/> of CSS3 for this recipe. You can find many tutorials online (see the references at the end of this recipe).</p><p>You also need to download the <span class="emphasis"><em>Notebook</em></span> dataset from the book's website (<a class="ulink" href="http://ipython-books.github.io">http://ipython-books.github.io</a>), and extract it in the current directory.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec86"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we create a new IPython profile to avoid cluttering our default profile as follows:<div class="informalexample"><pre class="programlisting">In [1]: !ipython profile create custom_css</pre></div></li><li class="listitem">In Python, we retrieve the path to this profile (<code class="literal">~/.ipython</code>) and to the <code class="literal">custom.css</code> file (empty by default).<div class="informalexample"><pre class="programlisting">In [2]: dir = !ipython locate profile custom_css
        dir = dir[0]
In [3]: import os
        csspath = os.path.realpath(os.path.join(
                    dir, 'static/custom/custom.css'))
In [4]: csspath
Out[4]: '~\.ipython\profile_custom_css\static\
                                       custom\custom.css'</pre></div></li><li class="listitem">We can now edit this<a id="id382" class="indexterm"/> file here. We change the background<a id="id383" class="indexterm"/> color, the font size of code cells, the border of some cells, and we highlight the selected cells in edit mode.<div class="informalexample"><pre class="programlisting">In [5]: %%writefile {csspath}
        
        body {
            /* Background color for the whole notebook. */
            background-color: #f0f0f0;
        }
        
        /* Level 1 headers. */
        h1 {
            text-align: right;
            color: red;
        }
        
        /* Code cells. */
        div.input_area &gt; div.highlight &gt; pre {
            font-size: 10px;
        }
        
        /* Output images. */
        div.output_area img {
            border: 3px #ababab solid;
            border-radius: 8px;
        }
        
        /* Selected cells. */
        div.cell.selected {
            border: 3px #ababab solid;
            background-color: #ddd;
        }
        
        /* Code cells in edit mode. */
        div.cell.edit_mode {
            border: 3px red solid;
            background-color: #faa;
        }
Overwriting C:\Users\Cyrille\.ipython\profile_custom_css\static\custom\custom.css</pre></div><p>Opening a notebook with the <code class="literal">custom_css</code> profile (with the <code class="literal">ipython notebook --profile=custom_css</code> command) leads to a custom style as follows:</p><div class="mediaobject"><img src="images/4818OS_03_09.jpg" alt="How to do it..."/><div class="caption"><p>Custom CSS in the interactive notebook interface</p></div></div></li><li class="listitem">We can also use<a id="id384" class="indexterm"/> this style sheet with nbconvert. We just have<a id="id385" class="indexterm"/> to convert a notebook to a static HTML document, and copy the <code class="literal">custom.css</code> file in the current directory. Here, we use a test notebook that has been downloaded from the book's website (see <span class="emphasis"><em>Getting ready</em></span>):<div class="informalexample"><pre class="programlisting">In [6]: !cp {csspath} custom.css
        !ipython nbconvert --to html data/test.ipynb
[NbConvertApp] Writing 187617 bytes to test.html</pre></div></li><li class="listitem">Here is what this HTML document looks like:<div class="informalexample"><pre class="programlisting">In [7]: from IPython.display import IFrame
        IFrame('test.html', 600, 650)</pre></div><div class="mediaobject"><img src="images/4818OS_03_10.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec87"/>There's more...</h2></div></div></div><p>Here are a few tutorials and references <a id="id386" class="indexterm"/>about CSS:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">CSS tutorial on w3schools, at <a class="ulink" href="http://www.w3schools.com/css/DEFAULT.asp">www.w3schools.com/css/DEFAULT.asp</a></li><li class="listitem" style="list-style-type: disc">CSS tutorial on Mozilla Developer Network, at <a class="ulink" href="https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Getting_started">https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Getting_started</a></li><li class="listitem" style="list-style-type: disc">Blog post by Matthias Bussonnier about how to customize the notebook CSS, at <a class="ulink" href="http://nbviewer.ipython.org/github/Carreau/posts/blob/master/Blog1.ipynb">http://nbviewer.ipython.org/github/Carreau/posts/blob/master/Blog1.ipynb</a></li></ul></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec88"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding custom controls in the notebook toolbar</em></span> recipe </li></ul></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Using interactive widgets – a piano in the notebook"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Using interactive widgets – a piano in the notebook</h1></div></div></div><p>Starting with IPython 2.0, we <a id="id387" class="indexterm"/>can put interactive widgets in notebooks to create rich GUI applications that interact with our Python kernel. IPython comes with a rich set of graphical controls such as buttons, sliders, and drop-down menus. We have full control of their placement and appearance. We can combine different widgets to form complex layouts. We can even create our own interactive widgets from scratch as we will see in the next recipe, <span class="emphasis"><em>Creating a custom Javascript widget in the notebook – a spreadsheet editor for pandas</em></span>.</p><p>In this recipe, we will show many possibilities offered by the interactive widget API in IPython 2.0+. We will create a very basic piano in the notebook.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec89"/>Getting ready</h2></div></div></div><p>You need to download <a id="id388" class="indexterm"/>the <span class="emphasis"><em>Piano</em></span> dataset from the book's website (http://<a class="ulink" href="http://ipython-books.github.io">ipython-books.github.io</a>). This dataset contains synthetic sounds of piano notes obtained on <code class="literal">archive.org</code> (CC0 1.0 Universal license). It is available at <a class="ulink" href="https://archive.org/details/SynthesizedPianoNotes">https://archive.org/details/SynthesizedPianoNotes</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec90"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's import a few modules as follows:<div class="informalexample"><pre class="programlisting">In [1]: import numpy as np
        import os
        from IPython.display import (Audio, display,
                                     clear_output)
        from IPython.html import widgets
        from functools import partial</pre></div></li><li class="listitem">To create a piano, we will draw one button per note. The corresponding note plays when the user clicks on the button. This is implemented by displaying an <code class="literal">&lt;audio&gt;</code> element as follows:<div class="informalexample"><pre class="programlisting">In [2]: dir = 'data/synth'
In [3]: # This is the list of notes.
        notes = 'C,C#,D,D#,E,F,F#,G,G#,A,A#,B,C'.split(',')
In [4]: def play(note, octave=0):
            """This function displays an HTML Audio element
            that plays automatically when it appears."""
            f = os.path.join(dir, 
                 "piano_{i}.mp3".format(i=note+12*octave))
            clear_output()
            display(Audio(filename=f, autoplay=True))</pre></div></li><li class="listitem">We are going to place all buttons within a container widget. In IPython 2.0, widgets can be organized hierarchically. One common use case is to organize several widgets in a given layout. Here, <code class="literal">piano</code> will contain 12 buttons for the 12 notes:<div class="informalexample"><pre class="programlisting">In [5]: piano = widgets.ContainerWidget()</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p>The API for creating container widgets such as horizontal or vertical boxes has changed in IPython 3.0. Refer to IPython's documentation for more details.</p></div></div></li><li class="listitem">We create our first widget: a slider control that specifies the octave (0 or 1 here):<div class="informalexample"><pre class="programlisting">In [6]: octave_slider = widgets.IntSliderWidget()
        octave_slider.max = 1
        octave_slider</pre></div><div class="mediaobject"><img src="images/4818OS_03_11.jpg" alt="How to do it..."/></div></li><li class="listitem">Now, we create the<a id="id389" class="indexterm"/> buttons. There are several steps. First, we instantiate a <code class="literal">ButtonWidget</code> object for each note. Then, we specify a <code class="literal">callback()</code> function that plays the corresponding note (given by an index) at a given octave (given by the current value of the octave slider). Finally, we set the CSS of each button, notably the white or black color.<div class="informalexample"><pre class="programlisting">In [7]: buttons = []
        for i, note in enumerate(notes):
            button = widgets.ButtonWidget(description=note)
            
            def on_button_clicked(i, _):
                play(i+1, octave_slider.value)
                
            button.on_click(partial(on_button_clicked, i))
            
            button.set_css({
                      'width': '30px', 
                      'height': '60px',
                      'padding': '0',
                      'color': 
                          ('black', 'white')['#' in note],
                      'background':
                          ('white', 'black')['#' in note],
                           'border': '1px solid black',
                           'float': 'left'})
            
            buttons.append(button)</pre></div></li><li class="listitem">Finally, we arrange all widgets within the containers. The <code class="literal">piano</code> container contains the buttons, and the main container (<code class="literal">container</code>) contains the slider and the piano. This can be implemented:<div class="informalexample"><pre class="programlisting">In [8]: piano.children = buttons
In [9]: container = widgets.ContainerWidget()
        container.children = [octave_slider,
                              piano]</pre></div></li><li class="listitem">By default, widgets are<a id="id390" class="indexterm"/> organized vertically within a container. Here, the octave slider will be above the piano. Within the piano, we want all notes to be arranged horizontally. We do this by replacing the default <code class="literal">vbox</code> CSS class by the <code class="literal">hbox</code> class. The following screenshot shows the piano in the IPython notebook:<div class="informalexample"><pre class="programlisting">In [10]: display(container)
         piano.remove_class('vbox')
         piano.add_class('hbox')</pre></div><div class="mediaobject"><img src="images/4818OS_03_13.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec91"/>How it works...</h2></div></div></div><p>The IPython widgets are represented by rich objects that are shared between the Python kernel and the browser. A widget contains special attributes called<a id="id391" class="indexterm"/> <span class="strong"><strong>trait attributes</strong></span>. For example, the <code class="literal">value</code> trait attribute of <code class="literal">SliderWidget</code> is dynamically and automatically linked to the value that is selected by the user in the notebook's slider.</p><p>This link is bidirectional. Changing this attribute in Python updates the slider in the notebook.</p><p>The placement of the widgets is controlled by container widgets and with CSS classes. You will find more information in the documentation.</p><p>This architecture enables the creation of rich graphical applications in the notebook that are backed by Python code.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec92"/>There's more...</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Widget <a id="id392" class="indexterm"/>examples at <a class="ulink" href="http://nbviewer.ipython.org/github/ipython/ipython/blob/master/examples/Interactive%20Widgets/Index.ipynb">http://nbviewer.ipython.org/github/ipython/ipython/blob/master/examples/Interactive%20Widgets/Index.ipynb</a></li></ul></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec93"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a custom JavaScript widget in the notebook – a spreadsheet editor for pandas</em></span> recipe</li></ul></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Creating a custom JavaScript widget in the notebook – a spreadsheet editor for pandas"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec31"/>Creating a custom JavaScript widget in the notebook – a spreadsheet editor for pandas</h1></div></div></div><p>We have previously introduced<a id="id393" class="indexterm"/> the new interactive features of the<a id="id394" class="indexterm"/> IPython notebook 2.0. In this recipe, we dive deeper into the subject by showing how to go beyond the existing widgets provided by IPython 2.0. Specifically, we will create a custom JavaScript-based widget that communicates with the Python kernel.</p><p>Specifically, we will create a basic interactive Excel-like data grid editor in the IPython notebook, compatible with pandas' <code class="literal">DataFrame</code>. Starting from a <code class="literal">DataFrame</code> object, we will be able to edit it within a GUI in the notebook. The editor is based on the <code class="literal">Handsontable</code> JavaScript library<a id="id395" class="indexterm"/> (<a class="ulink" href="http://handsontable.com">http://handsontable.com</a>). Other JavaScript data grid editors could be used as well.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec94"/>Getting ready</h2></div></div></div><p>You will need both IPython 2.0+ and the Handsontable JavaScript library for this recipe. The following are the instructions to load this Javascript library in the IPython notebook:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, go to <a class="ulink" href="https://github.com/handsontable/jquery-handsontable/tree/master/dist">https://github.com/handsontable/jquery-handsontable/tree/master/dist</a>.</li><li class="listitem">Then, download <code class="literal">jquery.handsontable.full.css</code> and <code class="literal">jquery.handsontable.full.js</code>, and put these two files in <code class="literal">~\.ipython\profile_default\static\custom\</code>.</li><li class="listitem">In this folder, add the following line in <code class="literal">custom.js</code>:<div class="informalexample"><pre class="programlisting">require(['/static/custom/jquery.handsontable.full.js']);</pre></div></li><li class="listitem">In this folder, add the following line in <code class="literal">custom.css</code>:<div class="informalexample"><pre class="programlisting">@import "/static/custom/jquery.handsontable.full.css"</pre></div></li><li class="listitem">Now, refresh the notebook!</li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec95"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's <a id="id396" class="indexterm"/>import a few functions and <a id="id397" class="indexterm"/>classes as follows:<div class="informalexample"><pre class="programlisting">In [1]: from IPython.html import widgets
        from IPython.display import display
        from IPython.utils.traitlets import Unicode</pre></div></li><li class="listitem">We create a new widget. The <code class="literal">value</code> trait will contain the JSON representation of the entire table. This trait will be synchronized between Python and JavaScript, thanks to the IPython 2.0's widget machinery.<div class="informalexample"><pre class="programlisting">In [2]: class HandsonTableWidget(widgets.DOMWidget):
            _view_name = Unicode('HandsonTableView',
                                 sync=True)
            value = Unicode(sync=True)</pre></div></li><li class="listitem">Now, we write the JavaScript code for the widget. The three important functions that are responsible for the synchronization are as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">render</code> is for the widget initialization</li><li class="listitem" style="list-style-type: disc"><code class="literal">update</code> is for Python to JavaScript update</li><li class="listitem" style="list-style-type: disc"><code class="literal">handle_table_change</code> is for JavaScript to Python update<div class="informalexample"><pre class="programlisting">In [3]: %%javascript
var table_id = 0;
require(["widgets/js/widget"], function(WidgetManager){    
    // Define the HandsonTableView
    var HandsonTableView = IPython.DOMWidgetView.extend({
        
        render: function(){
            // Initialization: creation of the HTML elements
            // for our widget.
            
            // Add a &lt;div&gt; in the widget area.
            this.$table = $('&lt;div /&gt;')
                .attr('id', 'table_' + (table_id++))
                .appendTo(this.$el);

            // Create the Handsontable table.
            this.$table.handsontable({
            });
            
        },
        
        update: function() {
            // Python --&gt; Javascript update.
            
            // Get the model's JSON string, and parse it.
            var data = $.parseJSON(this.model.get('value'));

            // Give it to the Handsontable widget.
            this.$table.handsontable({data: data});
            
            return HandsonTableView.__super__.
                                         update.apply(this);
        },
        
        // Tell Backbone to listen to the change event 
        // of input controls.
        events: {"change": "handle_table_change"},
        
        handle_table_change: function(event) {
            // Javascript --&gt; Python update.
            
            // Get the table instance.
            var ht = this.$table.handsontable('getInstance');

            // Get the data, and serialize it in JSON.
            var json = JSON.stringify(ht.getData());

            // Update the model with the JSON string.
            this.model.set('value', json);
            
            this.touch();
        },
    });
    
    // Register the HandsonTableView with the widget manager.
    WidgetManager.register_widget_view(
        'HandsonTableView', HandsonTableView);
});</pre></div></li></ul></div></li><li class="listitem">Now, we <a id="id398" class="indexterm"/>have a synchronized table<a id="id399" class="indexterm"/> widget that we can already use. However, we would like to integrate it with pandas. To do this, we create a light wrapper around a <code class="literal">DataFrame</code> instance. We create two callback functions for synchronizing the pandas object with the IPython widget. Changes in the GUI will automatically trigger a change in <code class="literal">DataFrame</code>, but the converse is not true. We'll need to re-display the widget if we change the <code class="literal">DataFrame</code> instance in Python:<div class="informalexample"><pre class="programlisting">In [4]: from io import StringIO
        import numpy as np
        import pandas as pd
In [5]: class HandsonDataFrame(object):
            def __init__(self, df):
                self._df = df
                self._widget = HandsonTableWidget()
                self._widget.on_trait_change(
                           self._on_data_changed, 'value')
                self._widget.on_displayed(self._on_displayed)
                
            def _on_displayed(self, e):
                # DataFrame ==&gt; Widget (upon initialization)
                json = self._df.to_json(orient='values')
                self._widget.value = json
                
            def _on_data_changed(self, e, val):
                # Widget ==&gt; DataFrame (called every time the
                # user changes a value in the widget)
                buf = StringIO(val)
                self._df = pd.read_json(buf, orient='values')
                
            def to_dataframe(self):
                return self._df
                
            def show(self):
                display(self._widget)</pre></div></li><li class="listitem">Now, let's test all that! We first create a random <code class="literal">DataFrame</code> instance:<div class="informalexample"><pre class="programlisting">In [6]: data = np.random.randint(size=(3, 5),
                                 low=100, high=900)
        df = pd.DataFrame(data)
        df
Out[6]:      
352  201  859  322  352
326  519  848  802  642
171  480  213  619  192</pre></div></li><li class="listitem">We <a id="id400" class="indexterm"/>wrap it in <code class="literal">HandsonDataFrame</code> and show<a id="id401" class="indexterm"/> it as follows:<div class="informalexample"><pre class="programlisting">In [7]: ht = HandsonDataFrame(df)
        ht.show()</pre></div><div class="mediaobject"><img src="images/4818OS_03_14.jpg" alt="How to do it..."/></div></li><li class="listitem">We can now change the values interactively, and they will be changed in Python accordingly:<div class="informalexample"><pre class="programlisting">In [8]: ht.to_dataframe()
Out[8]:
352  201  859   322  352
326  519  848  1024  642
171  480  213   619  192</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec96"/>How it works...</h2></div></div></div><p>Let's explain briefly the architecture underlying the interactive Python-JavaScript communication in IPython 2.0+.</p><p>The implementation follows the <span class="strong"><strong>Model-View-Controller</strong></span> (<span class="strong"><strong>MVC</strong></span>)<a id="id402" class="indexterm"/> design pattern, which is popular in GUI applications. There is a model in the backend (Python kernel) that holds some data. In the frontend (browser), there are one or several views of that model. Those views are dynamically synchronized with the model. When an attribute of the model changes on Python's side, it also changes on JavaScript's side, and vice versa. We can implement Python and JavaScript functions to respond to model changes. These changes are generally triggered by a user action.</p><p>In Python, dynamic attributes are implemented as traits. These special class attributes automatically trigger callback functions when they are updated. In JavaScript, the <code class="literal">Backbone.js</code> MVC library is used. The communication between Python and the browser is done via <a id="id403" class="indexterm"/><span class="strong"><strong>Comms</strong></span>, a special communication protocol in IPython.</p><p>To create a new widget, we<a id="id404" class="indexterm"/> need to create a class deriving<a id="id405" class="indexterm"/> from <code class="literal">DOMWidget</code>. Then, we define trait attributes that can be synchronized between Python and JavaScript if <code class="literal">sync=True</code> is passed to the trait constructors. We can register callback functions that react to trait changes (from either Python or JavaScript), using <code class="literal">widget.on_trait_change(callback, trait_name)</code>. The <code class="literal">callback()</code> function can have one of the following signatures:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">callback()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">callback(trait_name)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">callback(trait_name, new_value)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">callback(trait_name, old_value, new_value)</code></li></ul></div><p>In JavaScript, the <code class="literal">render()</code> function<a id="id406" class="indexterm"/> creates the HTML elements in the cell's widget area upon initialization. The <code class="literal">update()</code> method<a id="id407" class="indexterm"/> allows us to react to changes in the model in the backend side (Python). In addition, we can use <code class="literal">Backbone.js</code> to react to changes in the frontend (browser). By extending the widget with the <code class="literal">{"change": "callback"}</code> events, we tell <code class="literal">Backbone.js</code> to call the <code class="literal">callback()</code> JavaScript function as soon as the HTML input controls change. This is how we react to user-triggered actions here.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec97"/>There's more...</h2></div></div></div><p>The following are the ways this proof-of-concept could be improved:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Synchronizing only changes instead of synchronizing the whole array every time (the method used here would be slow on large tables)</li><li class="listitem" style="list-style-type: disc">Avoiding recreating a new <code class="literal">DataFrame</code> instance upon every change, but updating the same <code class="literal">DataFrame</code> instance in-place</li><li class="listitem" style="list-style-type: disc">Supporting named columns</li><li class="listitem" style="list-style-type: disc">Hiding the wrapper, that is, make it so that the default rich representation of <code class="literal">DataFrame</code> in the notebook is <code class="literal">HandsonDataFrame</code></li><li class="listitem" style="list-style-type: disc">Implementing everything in an easy-to-use extension</li></ul></div><p>Here are a few references<a id="id408" class="indexterm"/> about the widget architecture in the IPython notebook 2.0+:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Official example about custom widgets, available at <a class="ulink" href="http://nbviewer.ipython.org/github/ipython/ipython/tree/master/examples/Interactive%20Widgets">http://nbviewer.ipython.org/github/ipython/ipython/tree/master/examples/Interactive%20Widgets</a></li><li class="listitem" style="list-style-type: disc">MVC pattern in Wikipedia, at <a class="ulink" href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller</a></li><li class="listitem" style="list-style-type: disc">Backbone.js, available at <a class="ulink" href="http://backbonejs.org/">http://backbonejs.org/</a></li><li class="listitem" style="list-style-type: disc">Course on <code class="literal">Backbone.js</code>, available at <a class="ulink" href="http://www.codeschool.com/courses/anatomy-of-backbonejs">www.codeschool.com/courses/anatomy-of-backbonejs</a></li><li class="listitem" style="list-style-type: disc">IPEP 21: Widget Messages (comms), available at <a class="ulink" href="https://github.com/ipython/ipython/wiki/IPEP-21%3A-Widget-Messages">https://github.com/ipython/ipython/wiki/IPEP-21%3A-Widget-Messages</a></li><li class="listitem" style="list-style-type: disc">IPEP 23: IPython <a id="id409" class="indexterm"/>widgets, available at <a class="ulink" href="https://github.com/ipython/ipython/wiki/IPEP-23%3A-Backbone.js-Widgets">https://github.com/ipython/ipython/wiki/IPEP-23%3A-Backbone.js-Widgets</a></li></ul></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec98"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Processing webcam images in real time from the notebook</em></span> recipe</li></ul></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Processing webcam images in real time from the notebook"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec32"/>Processing webcam images in real time from the notebook</h1></div></div></div><p>In this recipe, we show<a id="id410" class="indexterm"/> how to let the notebook and the <a id="id411" class="indexterm"/>Python kernel communicate in both directions.</p><p>Specifically, we will retrieve the webcam feed from the browser using HTML5's <code class="literal">&lt;video&gt;</code> element, and pass it to Python in real time using the interactive capabilities of the IPython notebook 2.0+. Then, we will process the image in Python with an edge detector (implemented in scikit-image), and display it in the notebook in real time.</p><p>Most of the code for this recipe comes from Jason Grout's example, available at <a class="ulink" href="https://github.com/jasongrout/ipywidgets">https://github.com/jasongrout/ipywidgets</a>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec99"/>Getting ready</h2></div></div></div><p>You need Pillow and scikit-image for this recipe. (For more information, refer to <a class="link" href="ch11.html" title="Chapter 11. Image and Audio Processing">Chapter 11</a>, <span class="emphasis"><em>Image and Audio Processing</em></span>.)</p><p>You also need a recent browser supporting the HTML5 capture API. You can find the specification at <a class="ulink" href="http://dev.w3.org/2011/webrtc/editor/getusermedia.html">http://dev.w3.org/2011/webrtc/editor/getusermedia.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec100"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We need to import several modules as follows:<div class="informalexample"><pre class="programlisting">In [1]: from IPython.html.widgets import DOMWidget
        from IPython.utils.traitlets import (Unicode, Bytes,
                                             Instance)
        from IPython.display import display
        
        from skimage import io, filter, color
        import urllib
        import base64
        from PIL import Image
        from io import BytesIO # to change in Python 2
        import numpy as np
        from numpy import array, ndarray
        import matplotlib.pyplot as plt</pre></div></li><li class="listitem">We define <a id="id412" class="indexterm"/>two functions to convert <a id="id413" class="indexterm"/>images from and to base64 strings. This conversion is a common way to pass binary data between processes (in our case, the browser and Python):<div class="informalexample"><pre class="programlisting">In [2]: def to_b64(img):
            imgdata = BytesIO()
            pil = Image.fromarray(img)
            pil.save(imgdata, format='PNG')
            imgdata.seek(0)
            return urllib.parse.quote(
                        base64.b64encode(
                            imgdata.getvalue()))
In [3]: def from_b64(b64):
            im = Image.open(BytesIO(
                                    base64.b64decode(b64)))
            return array(im)</pre></div></li><li class="listitem">We define a Python function that will process the webcam image in real time. It accepts and returns a NumPy array. This function applies an edge detector with the <code class="literal">roberts()</code> function in scikit-image as follows:<div class="informalexample"><pre class="programlisting">In [4]: def process_image(image):
            img = filter.roberts(image[:,:,0]/255.)
            return (255-img*255).astype(np.uint8)</pre></div></li><li class="listitem">Now, we create a custom widget to handle the bidirectional communication of the video flow between the browser and Python:<div class="informalexample"><pre class="programlisting">In [5]: 
class Camera(DOMWidget):
    _view_name = Unicode('CameraView', sync=True)
    
    # This string contains the base64-encoded raw
    # webcam image (browser -&gt; Python).
    imageurl = Unicode('', sync=True)
    
    # This string contains the base64-encoded processed 
    # webcam image(Python -&gt; browser).
    imageurl2 = Unicode('', sync=True)
    
    # This function is called whenever the raw webcam
    # image is changed.
    def _imageurl_changed(self, name, new):
        head, data = new.split(',', 1)
        if not data:
            return
    
        # We convert the base64-encoded string
        # to a NumPy array.
        image = from_b64(data)
    
        # We process the image.
        image = process_image(image)
    
        # We convert the processed image
        # to a base64-encoded string.
        b64 = to_b64(image)
    
        self.imageurl2 = 'data:image/png;base64,' + b64</pre></div></li><li class="listitem">The next <a id="id414" class="indexterm"/>step is to write the JavaScript<a id="id415" class="indexterm"/> code for the widget. The code is long, so we just highlight the important parts here. The full code is on the book's website:<div class="informalexample"><pre class="programlisting">In [6]: %%javascript 

var video        = $('&lt;video&gt;')[0];
var canvas       = $('&lt;canvas&gt;')[0];
var canvas2       = $('&lt;img&gt;')[0];
[...]

require(["widgets/js/widget"], function(WidgetManager){
    var CameraView = IPython.DOMWidgetView.extend({
        render: function(){
            var that = this;

            // We append the HTML elements.
            setTimeout(function() {
                that.$el.append(video).
                         append(canvas).
                         append(canvas2);}, 200);
            
            // We initialize the webcam.
            [...]
            
            // We initialize the size of the canvas.
            video.addEventListener('canplay', function(ev){
                if (!streaming) {
                  height = video.videoHeight / (
                      video.videoWidth/width);
                  video.setAttribute('width', width);
                  video.setAttribute('height', height);
                  [...]
                  streaming = true;
                }
            }, false);
            
            // Play/Pause functionality.
            var interval;
            video.addEventListener('play', function(ev){
                // We get the picture every 100ms.    
                interval = setInterval(takepicture, 100);
            })
            video.addEventListener('pause', function(ev){
                clearInterval(interval);
            })
            // This function is called at each time step.
            // It takes a picture and sends it to the model.
            function takepicture() {
                canvas.width = width; canvas.height = height;
                canvas2.width = width; canvas2.height = height;
                
                video.style.display = 'none';
                canvas.style.display = 'none';
                
                // We take a screenshot from the webcam feed and 
                // we put the image in the first canvas.
                canvas.getContext('2d').drawImage(video, 
                    0, 0, width, height);
                
                // We export the canvas image to the model.
                that.model.set('imageurl',
                               canvas.toDataURL('image/png'));
                that.touch();
            }
        },
        
        update: function(){
            // This function is called whenever Python modifies
            // the second (processed) image. We retrieve it and
            // we display it in the second canvas.
            var img = this.model.get('imageurl2');
            canvas2.src = img;
            return CameraView.__super__.update.apply(this);
        }
    });
    
    // Register the view with the widget manager.
    WidgetManager.register_widget_view('CameraView', 
                                       CameraView);
});</pre></div></li><li class="listitem">Finally, we<a id="id416" class="indexterm"/> create and display the widget<a id="id417" class="indexterm"/> as follows:<div class="informalexample"><pre class="programlisting">In [7]: c = Camera()
        display(c)</pre></div><div class="mediaobject"><img src="images/4818OS_03_15.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec101"/>How it works...</h2></div></div></div><p>Let's explain the principle of this implementation. The model has two attributes: the incoming (raw) image from the browser and the outgoing (processed) image from Python. Every 100 milliseconds, JavaScript makes a capture of the webcam feed (in the <code class="literal">&lt;video&gt;</code> HTML element) by copying it to a first canvas. The canvas image is serialized in base64 and assigned to the first model attribute. Then, the Python function <code class="literal">_imageurl_changed()</code> is called. The image is deserialized, processed by scikit-image, and reserialized. The second attribute is then modified by Python, and is set to the serialized processed image. Finally, the <code class="literal">update()</code> function in JavaScript deserializes the processed<a id="id418" class="indexterm"/> image and displays it in a second<a id="id419" class="indexterm"/> canvas.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec102"/>There's more...</h2></div></div></div><p>The speed of this example could be greatly improved by capturing the webcam image from Python rather than from the browser. Here, the bottleneck probably stems from the two transfers that occur at every time step from the browser to Python and conversely.</p><p>It would be more efficient to capture the webcam's image from Python using a library such as <code class="literal">OpenCV</code> or <code class="literal">SimpleCV</code>. However, since these libraries may be difficult to install, it is much simpler to let the browser access the webcam device.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec103"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a custom JavaScript widget in the notebook – a spreadsheet editor for pandas</em></span> recipe</li></ul></div></div></div></div>
</body></html>